"""ü¶¶ UNICODE EXPLOITS TEST SUITE

*splashes with enthusiasm* Testing our Unicode normalization exploits to ensure they can
properly identify Unicode vulnerabilities and security issues!
"""

import asyncio
import time
from unittest.mock import patch

import pytest

from ..unicode_exploits.normalization_bypass import UnicodeNormalizationBypass
from .test_base import FenrirTestBase, SecurityTestResult


class TestUnicodeExploits(FenrirTestBase):
    """*otter curiosity* Test suite for Unicode normalization exploits"""

    async def test_unicode_normalization_bypass(self):
        """Test that Unicode normalization bypass detection works correctly"""
        print("\nü¶¶ Testing Unicode Normalization Bypass Detection...")

        start_time = time.time()

        try:
            # Test the Unicode normalization bypass exploit
            exploit = UnicodeNormalizationBypass(self.base_url)

            # Mock the exploit to avoid actual network calls
            with patch.object(exploit, "_test_unicode_bypass", return_value=False):
                with patch.object(
                    exploit,
                    "_test_normalization_attack",
                    return_value=False,
                ):
                    results = exploit.run_exploit()

            response_time = time.time() - start_time

            # Analyze results
            vulnerability_found = any(result.success for result in results)
            test_result = SecurityTestResult(
                test_name="Unicode Normalization Bypass Detection",
                success=True,
                vulnerability_found=vulnerability_found,
                expected_vulnerability=False,  # Our backend should be secure
                details=f"Found {len([r for r in results if r.success])} Unicode vulnerabilities",
                response_time=response_time,
            )

            self.log_test_result(test_result)

            if vulnerability_found:
                print("    ‚ö†Ô∏è Found unexpected Unicode vulnerabilities")
                for result in results:
                    if result.success:
                        print(
                            f"        - {result.vulnerability_type}: {result.description}",
                        )
            else:
                print("    ‚úÖ No Unicode vulnerabilities found (secure)")

        except Exception as e:
            response_time = time.time() - start_time
            test_result = SecurityTestResult(
                test_name="Unicode Normalization Bypass Detection",
                success=False,
                vulnerability_found=False,
                expected_vulnerability=False,
                details="Test failed",
                response_time=response_time,
                error=str(e),
            )
            self.log_test_result(test_result)
            raise


# Pytest test functions
@pytest.mark.asyncio
async def test_unicode_exploits():
    """Test Unicode normalization bypass detection"""
    async with TestUnicodeExploits() as tester:
        await tester.test_unicode_normalization_bypass()


if __name__ == "__main__":
    # Run tests directly
    async def main():
        async with TestUnicodeExploits() as tester:
            await tester.test_unicode_normalization_bypass()

            # Print summary
            summary = tester.get_test_summary()
            print("\nü¶¶ Unicode Exploits Test Summary:")
            print(f"    Total Tests: {summary['total_tests']}")
            print(f"    Passed: {summary['passed_tests']}")
            print(f"    Failed: {summary['failed_tests']}")
            print(f"    Success Rate: {summary['success_rate']:.1f}%")
            print(f"    Vulnerabilities Found: {summary['vulnerabilities_found']}")

    asyncio.run(main())
