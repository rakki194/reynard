#!/bin/bash

# ğŸ” Pre-commit Shell Script Validation Hook
# Validates shell scripts before commit

echo "ğŸ” Validating shell scripts..."

# Check if shellcheck is installed
if ! command -v shellcheck &> /dev/null; then
    echo "âŒ shellcheck is not installed!"
    echo "ğŸ“¦ Install it with: sudo pacman -S shellcheck"
    exit 1
fi

# Get list of staged shell files
STAGED_SHELL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh|bash|zsh)$' || true)

if [ -z "$STAGED_SHELL_FILES" ]; then
    echo "âœ… No shell scripts staged for commit"
    exit 0
fi

echo "ğŸ“Š Found $(echo "$STAGED_SHELL_FILES" | wc -l) staged shell scripts"

# Validate each staged shell file
VALIDATION_FAILED=false

for script in $STAGED_SHELL_FILES; do
    echo "ğŸ” Validating $script..."
    
    if shellcheck --rcfile=.shellcheckrc "$script"; then
        echo "âœ… $script - Valid"
    else
        echo "âŒ $script - Issues found"
        VALIDATION_FAILED=true
    fi
done

if [ "$VALIDATION_FAILED" = true ]; then
    echo ""
    echo "âŒ Shell script validation failed!"
    echo "ğŸ”§ Fix the issues above before committing."
    echo "ğŸ’¡ Run 'pnpm run shell:validate' to see all issues."
    exit 1
else
    echo ""
    echo "âœ… All staged shell scripts are valid!"
fi
