#!/bin/bash

# 🔍 Pre-commit Workflow Validation Hook
# Validates GitHub Actions workflows before commit

echo "🔍 Validating GitHub Actions workflows..."

# Check if actionlint is installed
if ! command -v actionlint &> /dev/null; then
    echo "❌ actionlint is not installed!"
    echo "📦 Install it with: sudo pacman -S actionlint"
    exit 1
fi

# Get list of staged workflow files
STAGED_WORKFLOWS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.github/workflows/.*\.(yml|yaml)$' || true)

if [ -z "$STAGED_WORKFLOWS" ]; then
    echo "✅ No workflow files staged for commit"
    exit 0
fi

echo "📊 Found $(echo "$STAGED_WORKFLOWS" | wc -l) staged workflow files"

# Validate each staged workflow file
VALIDATION_FAILED=false

for workflow in $STAGED_WORKFLOWS; do
    echo "🔍 Validating $workflow..."
    
    if actionlint "$workflow"; then
        echo "✅ $workflow - Valid"
    else
        echo "❌ $workflow - Issues found"
        VALIDATION_FAILED=true
    fi
done

if [ "$VALIDATION_FAILED" = true ]; then
    echo ""
    echo "❌ Workflow validation failed!"
    echo "🔧 Fix the issues above before committing."
    echo "💡 Run 'pnpm run workflow:validate' to see all issues."
    exit 1
else
    echo ""
    echo "✅ All staged workflows are valid!"
fi
