#!/bin/bash

# ğŸ” Pre-commit Workflow Validation Hook
# Validates GitHub Actions workflows before commit

echo "ğŸ” Validating GitHub Actions workflows..."

# Check if actionlint is installed
if ! command -v actionlint &> /dev/null; then
    echo "âŒ actionlint is not installed!"
    echo "ğŸ“¦ Install it with: sudo pacman -S actionlint"
    exit 1
fi

# Get list of staged workflow files
STAGED_WORKFLOWS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.github/workflows/.*\.(yml|yaml)$' || true)

if [ -z "$STAGED_WORKFLOWS" ]; then
    echo "âœ… No workflow files staged for commit"
    exit 0
fi

echo "ğŸ“Š Found $(echo "$STAGED_WORKFLOWS" | wc -l) staged workflow files"

# Validate each staged workflow file
VALIDATION_FAILED=false

for workflow in $STAGED_WORKFLOWS; do
    echo "ğŸ” Validating $workflow..."
    
    if actionlint "$workflow"; then
        echo "âœ… $workflow - Valid"
    else
        echo "âŒ $workflow - Issues found"
        VALIDATION_FAILED=true
    fi
done

if [ "$VALIDATION_FAILED" = true ]; then
    echo ""
    echo "âŒ Workflow validation failed!"
    echo "ğŸ”§ Fix the issues above before committing."
    echo "ğŸ’¡ Run 'pnpm run workflow:validate' to see all issues."
    exit 1
else
    echo ""
    echo "âœ… All staged workflows are valid!"
fi
