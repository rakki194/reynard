#!/bin/bash

# üê∫ Pre-commit Workflow Shell Script Validation Hook
# Extracts and validates shell scripts embedded in GitHub Actions workflows
# This ensures bulletproof CI/CD security by hunting down every shell vulnerability

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${MAGENTA}üê∫ Validating workflow shell scripts...${NC}"

# Check if Node.js is available
if ! command -v node &> /dev/null; then
    echo -e "${RED}‚ùå Node.js is not installed!${NC}"
    echo -e "${YELLOW}üì¶ Install it with: sudo pacman -S nodejs npm${NC}"
    exit 1
fi

# Check if shellcheck is installed
if ! command -v shellcheck &> /dev/null; then
    echo -e "${RED}‚ùå shellcheck is not installed!${NC}"
    echo -e "${YELLOW}üì¶ Install it with: sudo pacman -S shellcheck${NC}"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
EXTRACTOR_SCRIPT="$SCRIPT_DIR/extract-workflow-shell.js"
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Check if extractor script exists
if [[ ! -f "${EXTRACTOR_SCRIPT}" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Workflow shell extractor not found at: ${EXTRACTOR_SCRIPT}${NC}"
    echo -e "${YELLOW}   Skipping workflow shell validation...${NC}"
    exit 0
fi

# Get list of staged workflow files
STAGED_WORKFLOW_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.github/workflows/.*\.(yml|yaml)$' || true)

if [[ -z "${STAGED_WORKFLOW_FILES}" ]]; then
    echo -e "${GREEN}‚úÖ No workflow files staged for commit${NC}"
    exit 0
fi

echo -e "${BLUE}üìÅ Staged workflow files:${NC}"
echo "${STAGED_WORKFLOW_FILES}" | sed 's/^/  - /'
echo ""

# Change to project root
cd "${PROJECT_ROOT}"

# Run workflow shell script extraction and validation
echo -e "${BLUE}üîç Extracting and validating shell scripts from workflows...${NC}"

if node "${EXTRACTOR_SCRIPT}" --verbose; then
    echo -e "${GREEN}‚úÖ All workflow shell scripts are valid!${NC}"
else
    WORKFLOW_SHELL_VALIDATION_EXIT_CODE=$?
    
    if [[ "${WORKFLOW_SHELL_VALIDATION_EXIT_CODE}" -eq 1 ]]; then
        echo -e "${RED}‚ùå Workflow shell script validation failed${NC}"
        echo -e "${RED}   Please fix the shell script issues above before committing${NC}"
        echo ""
        echo -e "${YELLOW}üí° Tips:${NC}"
        echo -e "${YELLOW}   - Run 'node scripts/validation/workflows/extract-workflow-shell.js --fix' to auto-fix common issues${NC}"
        echo -e "${YELLOW}   - Use '[[ ]]' instead of '[ ]' for bash tests${NC}"
        echo -e "${YELLOW}   - Add braces around variables: \${VAR} instead of \$VAR${NC}"
        echo -e "${YELLOW}   - Check .shellcheckrc configuration for rules${NC}"
        echo -e "${YELLOW}   - Use 'git commit --no-verify' to skip this check (not recommended)${NC}"
        exit 1
    else
        echo -e "${RED}‚ùå Workflow shell validation script failed unexpectedly${NC}"
        exit 1
    fi
fi
