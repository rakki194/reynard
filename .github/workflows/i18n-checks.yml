name: i18n Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  i18n-checks:
    runs-on: ubuntu-latest
    name: i18n Translation Checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Build testing package
      run: |
        cd packages/testing
        pnpm build
        
    - name: Validate i18n setup
      run: |
        cd packages/testing
        pnpm i18n:validate
        
    - name: Run ESLint with i18n rules
      run: |
        cd packages/testing
        pnpm i18n:eslint
      continue-on-error: true
      
    - name: Run comprehensive i18n tests
      run: |
        cd packages/testing
        pnpm i18n:test --output ../../i18n-results.json --report ../../i18n-report.md
        
    - name: Upload i18n results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: i18n-results
        path: |
          i18n-results.json
          i18n-report.md
        retention-days: 30
        
    - name: Comment PR with i18n results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const results = JSON.parse(fs.readFileSync('i18n-results.json', 'utf8'));
            const report = fs.readFileSync('i18n-report.md', 'utf8');
            
            const comment = `## üåç i18n Check Results
            
            ### Summary
            - **Total Packages**: ${results.summary.totalPackages}
            - **Successful**: ${results.summary.successfulPackages}
            - **Failed**: ${results.summary.failedPackages}
            - **Hardcoded Strings**: ${results.summary.totalHardcodedStrings}
            - **Missing Translations**: ${results.summary.totalMissingTranslations}
            - **RTL Issues**: ${results.summary.totalRTLIssues}
            - **Duration**: ${results.duration}ms
            
            ### Status
            ${results.overallSuccess ? '‚úÖ All i18n checks passed!' : '‚ùå Some i18n checks failed.'}
            
            <details>
            <summary>üìä Detailed Report</summary>
            
            \`\`\`markdown
            ${report}
            \`\`\`
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.error('Failed to create i18n comment:', error);
          }
          
    - name: Fail on i18n issues
      run: |
        if [ -f "i18n-results.json" ]; then
          SUCCESS=$(jq -r '.overallSuccess' i18n-results.json)
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå i18n checks failed"
            exit 1
          fi
        else
          echo "‚ùå i18n results file not found"
          exit 1
        fi
