<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ü¶ä Effect Dependency Test Page</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .header p {
        margin: 10px 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .content {
        padding: 40px;
      }

      .test-section {
        margin-bottom: 40px;
        padding: 30px;
        border: 2px solid #f1f2f6;
        border-radius: 8px;
        background: #fafbfc;
      }

      .test-section h2 {
        color: #2c3e50;
        margin-top: 0;
        font-size: 1.5rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
      }

      .test-controls {
        display: flex;
        gap: 15px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background: #229954;
        transform: translateY(-2px);
      }

      .btn-warning {
        background: #f39c12;
        color: white;
      }

      .btn-warning:hover {
        background: #e67e22;
        transform: translateY(-2px);
      }

      .status-display {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 6px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 13px;
        line-height: 1.5;
        margin: 20px 0;
        max-height: 300px;
        overflow-y: auto;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .metric-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .metric-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
        font-weight: 600;
      }

      .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .code-block {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 6px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 13px;
        line-height: 1.5;
        margin: 15px 0;
        overflow-x: auto;
      }

      .code-block .comment {
        color: #95a5a6;
      }

      .code-block .keyword {
        color: #3498db;
      }

      .code-block .string {
        color: #e74c3c;
      }

      .code-block .number {
        color: #f39c12;
      }

      .footer {
        background: #34495e;
        color: #ecf0f1;
        padding: 30px;
        text-align: center;
      }

      .footer p {
        margin: 0;
        opacity: 0.8;
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
          border-radius: 8px;
        }

        .content {
          padding: 20px;
        }

        .test-controls {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ü¶ä Effect Dependency Test Page</h1>
        <p>Testing SolidJS createEffect patterns to prevent Cloudflare-style outages</p>
      </div>

      <div class="content">
        <!-- Problematic Patterns Section -->
        <div class="test-section">
          <h2>‚ùå Problematic Patterns (Will Trigger Alerts)</h2>
          <p>These patterns simulate the exact issues that caused the Cloudflare outage:</p>

          <div class="test-controls">
            <button class="btn btn-danger" onclick="testObjectRecreation()">Test Object Recreation</button>
            <button class="btn btn-danger" onclick="testArrayRecreation()">Test Array Recreation</button>
            <button class="btn btn-danger" onclick="testFunctionRecreation()">Test Function Recreation</button>
            <button class="btn btn-danger" onclick="testCloudflareScenario()">Test Cloudflare Scenario</button>
          </div>

          <div class="code-block">
            <span class="comment">// ‚ùå PROBLEMATIC: Object recreated on every render</span>
            <span class="keyword">const</span> tenantService = { organizationId: <span class="string">"org-123"</span>,
            userId: <span class="string">"user-456"</span>, metadata: { timestamp:
            <span class="keyword">Date</span>.now() <span class="comment">// Changes every time!</span>
            } };

            <span class="keyword">createEffect</span>(() => { fetchOrganizationData(tenantService); }, [tenantService]);
            <span class="comment">// ‚ùå Infinite loop!</span>
          </div>
        </div>

        <!-- Prevention Patterns Section -->
        <div class="test-section">
          <h2>‚úÖ Prevention Patterns (Safe)</h2>
          <p>These patterns demonstrate how to prevent infinite loops:</p>

          <div class="test-controls">
            <button class="btn btn-success" onclick="testStableObject()">Test Stable Object</button>
            <button class="btn btn-success" onclick="testMemoizedDeps()">Test Memoized Dependencies</button>
            <button class="btn btn-success" onclick="testPrimitiveDeps()">Test Primitive Dependencies</button>
            <button class="btn btn-success" onclick="testOptimizedApiCalls()">Test Optimized API Calls</button>
          </div>

          <div class="code-block">
            <span class="comment">// ‚úÖ CORRECT: Stable object reference</span>
            <span class="keyword">const</span> tenantService = <span class="keyword">createMemo</span>(() => ({
            organizationId: props.organizationId, userId: user.id, metadata: { timestamp:
            <span class="keyword">Date</span>.now() } }));

            <span class="keyword">createEffect</span>(() => { fetchOrganizationData(tenantService()); },
            [tenantService]); <span class="comment">// ‚úÖ Stable reference</span>
          </div>
        </div>

        <!-- Performance Monitoring Section -->
        <div class="test-section">
          <h2>üìä Performance Monitoring</h2>
          <p>Real-time monitoring of effect executions and API calls:</p>

          <div class="test-controls">
            <button class="btn btn-primary" onclick="startMonitoring()">Start Monitoring</button>
            <button class="btn btn-warning" onclick="stopMonitoring()">Stop Monitoring</button>
            <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
            <button class="btn btn-warning" onclick="clearLogs()">Clear Logs</button>
          </div>

          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value" id="effectCount">0</div>
              <div class="metric-label">Effect Executions</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="apiCallCount">0</div>
              <div class="metric-label">API Calls</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="alertCount">0</div>
              <div class="metric-label">Alerts</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="memoryUsage">0</div>
              <div class="metric-label">Memory (MB)</div>
            </div>
          </div>
        </div>

        <!-- Status Display -->
        <div class="test-section">
          <h2>üìã Status & Logs</h2>
          <div class="status-display" id="statusDisplay">
            <div class="alert alert-info">ü¶ä Effect monitoring system ready. Click "Start Monitoring" to begin.</div>
          </div>
        </div>
      </div>

      <div class="footer">
        <p>ü¶ä Reynard Effect Monitoring System - Preventing Cloudflare-style outages</p>
      </div>
    </div>

    <script>
      // Global variables for testing
      let effectMonitor = null;
      let isMonitoring = false;
      let effectCount = 0;
      let apiCallCount = 0;
      let alertCount = 0;

      // Mock effect monitor for testing
      window.effectMonitor = {
        trackEffectExecution: function (effectId, executionTime, dependencySnapshot) {
          effectCount++;
          updateMetrics();
          log(`ü¶ä Effect executed: ${effectId} (${executionTime.toFixed(2)}ms)`);
        },
        trackApiCall: function (endpoint, method, requestId) {
          apiCallCount++;
          updateMetrics();
          log(`üåê API call: ${method} ${endpoint} (${requestId})`);
        },
        onAlert: function (callback) {
          // Mock alert callback
        },
      };

      function log(message) {
        const statusDisplay = document.getElementById("statusDisplay");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        statusDisplay.appendChild(logEntry);
        statusDisplay.scrollTop = statusDisplay.scrollHeight;
      }

      function updateMetrics() {
        document.getElementById("effectCount").textContent = effectCount;
        document.getElementById("apiCallCount").textContent = apiCallCount;
        document.getElementById("alertCount").textContent = alertCount;

        // Mock memory usage
        if (performance.memory) {
          document.getElementById("memoryUsage").textContent = (
            performance.memory.usedJSHeapSize /
            1024 /
            1024
          ).toFixed(1);
        }
      }

      function showAlert(message, type = "danger") {
        alertCount++;
        updateMetrics();

        const statusDisplay = document.getElementById("statusDisplay");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `üö® ${message}`;
        statusDisplay.appendChild(alert);
        statusDisplay.scrollTop = statusDisplay.scrollHeight;
      }

      // Test functions
      function testObjectRecreation() {
        log("üß™ Testing object recreation pattern...");

        for (let i = 0; i < 8; i++) {
          // This object is recreated every time - the bug!
          const tenantService = {
            organizationId: "org-123",
            userId: "user-456",
            permissions: ["read", "write"],
            metadata: {
              source: "dashboard",
              version: "1.0.0",
              timestamp: Date.now(), // This changes every time!
            },
          };

          window.effectMonitor.trackEffectExecution("object-recreation-effect", Math.random() * 10, tenantService);

          window.effectMonitor.trackApiCall("/api/v1/organizations", "GET", `req-${i}`);
        }

        showAlert("INFINITE LOOP DETECTED: Object recreation in dependency array", "danger");
      }

      function testArrayRecreation() {
        log("üß™ Testing array recreation pattern...");

        for (let i = 0; i < 6; i++) {
          // This array is recreated every time - the bug!
          const permissions = ["read", "write", "admin"];

          window.effectMonitor.trackEffectExecution("array-recreation-effect", Math.random() * 10, permissions);

          window.effectMonitor.trackApiCall("/api/v1/user-permissions", "GET", `req-${i}`);
        }

        showAlert("INFINITE LOOP DETECTED: Array recreation in dependency array", "danger");
      }

      function testFunctionRecreation() {
        log("üß™ Testing function recreation pattern...");

        for (let i = 0; i < 7; i++) {
          // This function is recreated every time - the bug!
          const callback = () => {
            console.log("Callback executed");
          };

          window.effectMonitor.trackEffectExecution("function-recreation-effect", Math.random() * 10, {
            callback: callback.toString(),
          });

          window.effectMonitor.trackApiCall("/api/v1/callback-endpoint", "POST", `req-${i}`);
        }

        showAlert("INFINITE LOOP DETECTED: Function recreation in dependency array", "danger");
      }

      function testCloudflareScenario() {
        log("üß™ Testing exact Cloudflare scenario...");

        for (let i = 0; i < 12; i++) {
          // This is the exact problematic pattern from Cloudflare
          const tenantService = {
            organizationId: "org-123",
            userId: "user-456",
            permissions: ["read", "write"],
            lastUpdated: Date.now(),
            metadata: {
              source: "dashboard",
              version: "1.0.0",
              timestamp: Date.now(), // This changes every time!
            },
          };

          window.effectMonitor.trackEffectExecution("cloudflare-dashboard-effect", Math.random() * 15, tenantService);

          window.effectMonitor.trackApiCall("/api/v1/organizations", "GET", `cloudflare-req-${i}`);
        }

        showAlert("CLOUDFLARE BUG REPRODUCED: Dashboard effect causing infinite API calls", "danger");
      }

      function testStableObject() {
        log("üß™ Testing stable object pattern...");

        // Create stable object reference
        const stableTenantService = {
          organizationId: "org-123",
          userId: "user-456",
          permissions: ["read", "write"],
          metadata: {
            source: "dashboard",
            version: "1.0.0",
            timestamp: 1234567890, // Fixed timestamp
          },
        };

        for (let i = 0; i < 5; i++) {
          // Use the stable reference
          const tenantService = stableTenantService;

          window.effectMonitor.trackEffectExecution("stable-effect", Math.random() * 5, tenantService);

          // Only make API call once
          if (i === 0) {
            window.effectMonitor.trackApiCall("/api/v1/organizations", "GET", `stable-req-${i}`);
          }
        }

        showAlert("‚úÖ STABLE PATTERN: No infinite loop detected", "success");
      }

      function testMemoizedDeps() {
        log("üß™ Testing memoized dependencies pattern...");

        let memoizedDeps = null;
        let lastDepsHash = "";

        for (let i = 0; i < 6; i++) {
          const deps = {
            userId: "user-456",
            organizationId: "org-123",
          };

          const depsHash = JSON.stringify(deps);
          const depsChanged = depsHash !== lastDepsHash;

          if (depsChanged) {
            memoizedDeps = deps;
            lastDepsHash = depsHash;

            window.effectMonitor.trackApiCall("/api/v1/user-data", "GET", `memoized-req-${i}`);
          }

          window.effectMonitor.trackEffectExecution("memoized-effect", Math.random() * 5, memoizedDeps);
        }

        showAlert("‚úÖ MEMOIZED PATTERN: Dependencies only changed once", "success");
      }

      function testPrimitiveDeps() {
        log("üß™ Testing primitive dependencies pattern...");

        const userId = "user-456";
        const organizationId = "org-123";
        const isActive = true;

        for (let i = 0; i < 4; i++) {
          window.effectMonitor.trackEffectExecution("primitive-effect", Math.random() * 5, {
            userId,
            organizationId,
            isActive,
          });

          // Only make API call once
          if (i === 0) {
            window.effectMonitor.trackApiCall("/api/v1/user-status", "GET", `primitive-req-${i}`);
          }
        }

        showAlert("‚úÖ PRIMITIVE PATTERN: Stable primitive references", "success");
      }

      function testOptimizedApiCalls() {
        log("üß™ Testing optimized API calls pattern...");

        let lastCallTime = 0;
        const debounceMs = 300;
        let actualApiCalls = 0;

        for (let i = 0; i < 10; i++) {
          const now = Date.now();
          if (now - lastCallTime > debounceMs) {
            actualApiCalls++;
            lastCallTime = now;

            window.effectMonitor.trackApiCall("/api/v1/data", "GET", `optimized-req-${actualApiCalls}`);
          }

          window.effectMonitor.trackEffectExecution("optimized-effect", Math.random() * 5, { iteration: i });
        }

        showAlert(`‚úÖ OPTIMIZED PATTERN: ${actualApiCalls} API calls (debounced from 10)`, "success");
      }

      function startMonitoring() {
        isMonitoring = true;
        log("ü¶ä Effect monitoring started");
        showAlert("Monitoring system active", "info");
      }

      function stopMonitoring() {
        isMonitoring = false;
        log("ü¶ä Effect monitoring stopped");
        showAlert("Monitoring system stopped", "warning");
      }

      function generateReport() {
        const report = `
ü¶ä Effect Monitoring Report
========================
Effect Executions: ${effectCount}
API Calls: ${apiCallCount}
Alerts: ${alertCount}
Memory Usage: ${performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1) + " MB" : "N/A"}

Recommendations:
${effectCount > 10 ? "- Fix infinite loops in effects" : "- Effect execution count is normal"}
${apiCallCount > 20 ? "- Reduce API call frequency" : "- API call count is normal"}
${alertCount > 0 ? "- Address detected issues" : "- No issues detected"}
            `;

        log("üìä Generated monitoring report:");
        log(report);
        showAlert("Monitoring report generated", "info");
      }

      function clearLogs() {
        document.getElementById("statusDisplay").innerHTML = "";
        effectCount = 0;
        apiCallCount = 0;
        alertCount = 0;
        updateMetrics();
        log("üßπ Logs cleared");
      }

      // Initialize
      updateMetrics();
      log("ü¶ä Effect monitoring system initialized");
    </script>
  </body>
</html>
