<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ollama Service Reconnection - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>Ollama Service Reconnection</h1>
      <div class="markdown-content"><h1>Ollama Service Reconnection</h1>
<p>The Ollama service now includes automatic reconnection functionality with exponential backoff to handle connection failures gracefully.</p>
<h2>Overview</h2>
<p>When the Ollama service connects to the server once and then gets disconnected, it will automatically attempt to reconnect every 5 seconds initially, with exponential timeout increases up to a maximum of 5 minutes between attempts.</p>
<h2>Features</h2>
<h3>Automatic Reconnection</h3>
<ul>
<li><strong>Initial Delay</strong>: 5 seconds</li>
<li><strong>Exponential Backoff</strong>: Each retry doubles the delay (5s → 10s → 20s → 40s → 80s → 160s → 300s)</li>
<li><strong>Maximum Delay</strong>: 5 minutes (300 seconds)</li>
<li><strong>Maximum Attempts</strong>: 10 attempts before giving up</li>
</ul>
<h3>Connection State Management</h3>
<p>The service tracks connection states:</p>
<ul>
<li><code>DISCONNECTED</code>: No active connection</li>
<li><code>CONNECTING</code>: Attempting to establish initial connection</li>
<li><code>CONNECTED</code>: Successfully connected</li>
<li><code>RECONNECTING</code>: Attempting to reconnect after disconnection</li>
</ul>
<h3>Health Check Integration</h3>
<p>Health checks detect connection failures and:</p>
<ol>
<li>Trigger reconnection loop if connection is lost</li>
<li>Reset connection state when connection is restored</li>
<li>Reset attempt counter on successful reconnection</li>
</ol>
<ul>
<li>Regular health checks (every 60 seconds) detect connection failures</li>
<li>Automatic reconnection loop starts when connection is lost</li>
<li>Connection state is restored when health checks succeed</li>
</ul>
<h2>Configuration</h2>
<p>The reconnection behavior can be configured by modifying these parameters in the <code>OllamaService</code> class:</p>
<pre><code class="hljs language-python"><span class="hljs-variable language_">self</span>._base_reconnection_delay = <span class="hljs-number">5</span>  <span class="hljs-comment"># Start with 5 seconds</span>
<span class="hljs-variable language_">self</span>._max_reconnection_delay = <span class="hljs-number">300</span>  <span class="hljs-comment"># Max 5 minutes</span>
<span class="hljs-variable language_">self</span>._reconnection_backoff_multiplier = <span class="hljs-number">2.0</span>  <span class="hljs-comment"># Double the delay each time</span>
<span class="hljs-variable language_">self</span>._max_reconnection_attempts = <span class="hljs-number">10</span>  <span class="hljs-comment"># Stop after 10 attempts</span></code></pre><h2>Usage</h2>
<p>The reconnection functionality is automatic and requires no user intervention:</p>
<ol>
<li><strong>Initial Connection</strong>: Service attempts to connect during initialization</li>
<li><strong>Connection Loss</strong>: If connection fails, reconnection loop starts automatically</li>
<li><strong>Reconnection</strong>: Service attempts to reconnect with exponential backoff</li>
<li><strong>Connection Restored</strong>: When connection is restored, normal operation resumes</li>
<li><strong>Max Attempts</strong>: If 10 attempts fail, reconnection stops until next health check</li>
</ol>
<h2>Monitoring</h2>
<p>The service provides connection state information through the <code>get_info()</code> method:</p>
<pre><code class="hljs language-python">info = ollama_service.get_info()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Connection State: <span class="hljs-subst">{info[<span class="hljs-string">&#x27;connection_state&#x27;</span>]}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Connection Attempts: <span class="hljs-subst">{info[<span class="hljs-string">&#x27;connection_attempts&#x27;</span>]}</span>&quot;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Was Ever Connected: <span class="hljs-subst">{info[<span class="hljs-string">&#x27;was_ever_connected&#x27;</span>]}</span>&quot;</span>)</code></pre><h2>Testing</h2>
<p>The reconnection functionality is thoroughly tested with:</p>
<ul>
<li>Unit tests for individual components</li>
<li>Integration tests for complete reconnection cycles</li>
<li>State transition tests</li>
<li>Exponential backoff timing tests</li>
</ul>
<p>Run the tests with:</p>
<pre><code class="hljs language-bash">python -m pytest app/tests/test_ollama_reconnection.py -v
python -m pytest app/tests/test_ollama_integration.py -v</code></pre><h2>Implementation Details</h2>
<h3>Reconnection Loop</h3>
<p>The reconnection loop runs as a background task and:</p>
<ol>
<li>Calculates delay using exponential backoff</li>
<li>Waits for the calculated delay</li>
<li>Attempts to reconnect using <code>reinitialize()</code></li>
<li>Updates connection state based on success/failure</li>
<li>Continues until connection is restored or max attempts reached</li>
</ol>
<h3>Cleanup</h3>
<p>The service properly cleans up reconnection tasks during shutdown to prevent resource leaks.</p>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>