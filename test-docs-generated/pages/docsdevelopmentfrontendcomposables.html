<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Composables - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>Composables</h1>
      <div class="markdown-content"><h1>Composables</h1>
<p>SolidJS composables in the Reynard framework live in <code>packages/composables/</code> and are prefixed with <code>use</code>. They<br>hide reusable reactive logic behind typed, minimal APIs and are designed to be modular and reusable across different Reynard applications.</p>
<h2>Conventions</h2>
<ul>
<li>Single responsibility and explicit return types (signals, memos, actions)</li>
<li>Lazy side-effects and onCleanup teardown inside the composable</li>
<li>Passive event listeners for scroll/touch by default; avoid <code>preventDefault</code><br>unless necessary</li>
<li>Prefer small signals/memos over large derived objects to limit re-computation<br>and re-rendering</li>
<li>Accept narrowly scoped options; avoid deep config objects</li>
</ul>
<h2>Current Composable Inventory</h2>
<p>The Reynard framework contains <strong>80+ composables</strong> organized by functionality across multiple packages:</p>
<h3>Core State Management (packages/core)</h3>
<ul>
<li><code>useAuthFetch.ts</code> - Authentication-aware fetch with token refresh</li>
<li><code>useServiceManager.ts</code> - Service status and health monitoring</li>
<li><code>useIndexing.ts</code> - Indexing operations and state</li>
<li><code>useNotifications.ts</code> - Notification system integration</li>
</ul>
<h3>UI Interactions</h3>
<ul>
<li><code>useDragAndDrop.tsx</code> - File drag and drop functionality</li>
<li><code>useScrollCoordinator.ts</code> - Advanced scroll coordination</li>
<li><code>useShortcutEngine.ts</code> - Keyboard shortcut management</li>
<li><code>useGalleryScroll.tsx</code> - Gallery-specific scroll handling</li>
<li><code>useGlobalEscapeManager.tsx</code> - Global escape key handling</li>
</ul>
<h3>Content Processing</h3>
<ul>
<li><code>useUnifiedCaptionGeneration.ts</code> - Multi-model caption generation</li>
<li><code>useDetectionModels.ts</code> - Object detection integration</li>
<li><code>useDiffusionLLM.ts</code> - Text generation with DreamOn/LLaDA models</li>
<li><code>useRAG.ts</code> - Retrieval-augmented generation</li>
<li><code>useRAGSearch.ts</code> - RAG search functionality</li>
<li><code>useRAGFileProcessing.ts</code> - RAG file processing</li>
</ul>
<h3>AI Integration</h3>
<ul>
<li><code>useComfy.ts</code> - ComfyUI workflow management</li>
<li><code>useComfyModels.ts</code> - ComfyUI model management</li>
<li><code>useComfyWorkflow.ts</code> - Workflow operations</li>
<li><code>useComfyQueue.ts</code> - Queue management</li>
<li><code>useComfyPresets.ts</code> - Preset management</li>
<li><code>useOllama.ts</code> - Ollama integration</li>
<li><code>useCrawl.ts</code> - Web crawling functionality</li>
</ul>
<h3>Performance &amp; Monitoring</h3>
<ul>
<li><code>usePerformanceMonitor.ts</code> - Performance tracking</li>
<li><code>useProgressiveLoading.ts</code> - Progressive loading strategies</li>
<li><code>useVirtualSelection.ts</code> - Virtual selection optimization</li>
<li><code>useScrollPerformanceMonitor.ts</code> - Scroll performance monitoring</li>
<li><code>useMemory.ts</code> - Memory usage tracking</li>
<li><code>useMemoryAlerts.ts</code> - Memory alert system</li>
</ul>
<h3>Visualization &amp; Analysis</h3>
<ul>
<li><code>useVisualizationProgress.ts</code> - Visualization progress tracking</li>
<li><code>useVisualizationExport.ts</code> - Export functionality</li>
<li><code>useEmbeddingReduction.ts</code> - Embedding dimensionality reduction</li>
<li><code>useBoxTransform.ts</code> - Bounding box transformations</li>
<li><code>useBoxResize.ts</code> - Box resizing operations</li>
<li><code>useBoxMove.ts</code> - Box movement operations</li>
<li><code>useOverlappingBoxCycling.ts</code> - Overlapping box management</li>
</ul>
<h3>File Operations</h3>
<ul>
<li><code>useFileUpload.tsx</code> - File upload functionality</li>
<li><code>useGlobalFileUpload.ts</code> - Global upload state</li>
<li><code>useCaptionRequestQueue.ts</code> - Caption request queuing</li>
<li><code>useCaptionHistory.tsx</code> - Caption history management</li>
</ul>
<h3>Git Integration</h3>
<ul>
<li><code>useGitManager.ts</code> - Git operations management</li>
<li><code>useGitOperations.ts</code> - Core git operations</li>
<li><code>useGitData.ts</code> - Git data management</li>
<li><code>useGlobalGitStatus.ts</code> - Global git status</li>
</ul>
<h3>Advanced Features</h3>
<ul>
<li><code>useServiceAwareFeatures.ts</code> - Service-aware feature management</li>
<li><code>useServiceAwareAuth.ts</code> - Service-aware authentication</li>
<li><code>useServiceNotifications.ts</code> - Service notification integration</li>
<li><code>useSearchIntegration.ts</code> - Search system integration</li>
<li><code>useEnhancedSummarize.ts</code> - Enhanced summarization</li>
<li><code>useSummarize.ts</code> - Basic summarization</li>
<li><code>useSummaryComparison.ts</code> - Summary comparison tools</li>
</ul>
<h3>Development &amp; Testing</h3>
<ul>
<li><code>useConfigWatcher.ts</code> - Configuration watching</li>
<li><code>useModelUsage.ts</code> - Model usage tracking</li>
<li><code>useModelUsageTrackerConfig.ts</code> - Usage tracker configuration</li>
<li><code>useModelLoadingStates.ts</code> - Model loading state management</li>
<li><code>useLanguageDetection.ts</code> - Language detection</li>
<li><code>useConnectionStatus.ts</code> - Connection status monitoring</li>
</ul>
<h2>Example: Comfy</h2>
<p><code>useComfy</code> exposes typed actions to queue and monitor Comfy jobs with<br>retry/backoff and notification groups. It returns functions for <code>queueWorkflow</code>,<br><code>textToImage</code>, <code>subscribeToStatus</code>, <code>fetchImage</code>, <code>ingestImage</code>, and<br><code>getComfyInfo</code>. It ensures EventSource cleanup via <code>onCleanup</code>.</p>
<h2>Testing</h2>
<p>Write tests that simulate rapid state changes and unmount cleanup. Validate that<br>passive listeners do not block scrolling. Follow the existing <code>vitest</code> and<br>Testing Library setup and assert that resource cleanup runs on disposal.</p>
<ul>
<li>Files:<ul>
<li><code>src/composables/*</code></li>
<li><code>docs/passive-events.md</code></li>
</ul>
</li>
</ul>
<h2>Lifecycle and cleanup</h2>
<p>Composables should set up side effects lazily and always tear them down. Use<br><code>onCleanup</code> to close streaming connections, clear timers, and remove listeners.<br>In <code>useComfy</code>, the <code>EventSource</code> is closed on disposal to prevent leaks. In<br><code>useAuthFetch</code>, the proactive refresh timer is cleared on cleanup. Prefer<br><code>onMount</code> only when you must access the DOM; otherwise, set up work at first use<br>or inside returned actions to keep initialization cheap.</p>
<p>Timers and animation frames must be tracked and cleared. In <code>useGalleryScroll</code>,<br>both <code>requestAnimationFrame</code> handles and <code>setInterval</code> IDs are stored and<br>cancelled during cleanup to avoid work after unmount.</p>
<h2>Event listeners and performance</h2>
<p>Follow the passive event listener guidance for scroll and touch interactions.<br>The default should be passive to improve scrolling performance, switching to<br>non-passive only when you call <code>preventDefault</code>. The <code>docs/passive-events.md</code><br>document contains the full rationale and examples.</p>
<p>The crawl streaming composable registers SSE-specific listeners with passive<br>options, which is appropriate because no default behavior is prevented:</p>
<pre><code class="hljs">es.addEventListener(<span class="hljs-string">&quot;submitted&quot;</span>, <span class="hljs-function"><span class="hljs-params">(ev)</span> =&gt;</span> {
    <span class="hljs-keyword">try</span> { handlers.onSubmitted?.(<span class="hljs-built_in">JSON</span>.parse((ev <span class="hljs-keyword">as</span> MessageEvent).data)); } <span class="hljs-keyword">catch</span> { }
}, { passive: <span class="hljs-literal">true</span> } <span class="hljs-keyword">as</span> any);
es.addEventListener(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-function"><span class="hljs-params">(ev)</span> =&gt;</span> {
    <span class="hljs-keyword">try</span> { handlers.onStatus?.(<span class="hljs-built_in">JSON</span>.parse((ev <span class="hljs-keyword">as</span> MessageEvent).data)); } <span class="hljs-keyword">catch</span> { }
}, { passive: <span class="hljs-literal">true</span> } <span class="hljs-keyword">as</span> any);
es.addEventListener(<span class="hljs-string">&quot;done&quot;</span>, <span class="hljs-function"><span class="hljs-params">(ev)</span> =&gt;</span> {
    <span class="hljs-keyword">try</span> { handlers.onDone?.(<span class="hljs-built_in">JSON</span>.parse((ev <span class="hljs-keyword">as</span> MessageEvent).data)); } <span class="hljs-keyword">catch</span> { }
    stop();
}, { passive: <span class="hljs-literal">true</span> } <span class="hljs-keyword">as</span> any);</code></pre><p>By contrast, gallery wheel navigation intentionally uses a non-passive listener<br>because it prevents the page from scrolling while using the wheel to navigate<br>images:</p>
<pre><code class="hljs"><span class="hljs-comment">// Prevent multiple handlers</span>
<span class="hljs-keyword">if</span> (wheelHandler) {
  galleryElement.removeEventListener(<span class="hljs-string">&#x27;wheel&#x27;</span>, wheelHandler);
}

wheelHandler = <span class="hljs-function">(<span class="hljs-params">e: WheelEvent</span>) =&gt;</span> {
  e.preventDefault();
  <span class="hljs-comment">// ... image navigation logic ...</span>
};

<span class="hljs-comment">// Use passive listener for performance where possible; here we require preventDefault</span>
galleryElement.addEventListener(<span class="hljs-string">&#x27;wheel&#x27;</span>, wheelHandler, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">false</span> });</code></pre><p>When adding listeners on <code>document</code> or <code>window</code>, keep the handler in a variable<br>so you can remove it exactly during cleanup. Prefer <code>{ once: true }</code> when<br>appropriate to reduce bookkeeping.</p>
<h2>Streaming and cancellation</h2>
<p>For streaming APIs, provide cancellation with <code>AbortController</code> and support an<br>optional external <code>AbortSignal</code> so callers can compose cancellation. In<br><code>useDiffusionLLM</code>, streaming helpers accept an external signal and attach an<br>abort handler, while managing an internal controller when none is provided. Idle<br>timeouts ensure streams do not hang indefinitely.</p>
<p>When using Server-Sent Events (<code>EventSource</code>), expose a small handle or a stop<br>function from the composable so callers can terminate the stream. Always close<br>the <code>EventSource</code> on completion and in <code>onCleanup</code>.</p>
<h2>Typing and API shape</h2>
<p>Return only the reactive primitives and actions that consumers need. Prefer<br>narrow, explicit types over large objects. Use <code>Accessor&lt;T&gt;</code>, <code>Setter&lt;T&gt;</code>, or<br><code>createResource</code> result tuples where suitable, and return typed functions for<br>actions. When returning an object, finalize the surface with <code>as const</code> if you<br>want callers to consume stable, read-only properties without accidental<br>mutation.</p>
<p>Keep options narrowly scoped and typed. Instead of deep configuration objects,<br>accept a small options parameter with explicit fields and defaults. This<br>improves discoverability and avoids reactivity work when unrelated fields<br>change.</p>
<h2>SSR safety and DOM access</h2>
<p>Guard all DOM access behind <code>onMount</code> so composables are safe to import in<br>non-DOM environments and during testing. Check for <code>window</code> or <code>document</code> only<br>inside <code>onMount</code> or returned actions that are called client-side. Avoid reading<br>layout or sizes during module initialization.</p>
<h2>Testing composables</h2>
<p>Write tests that cover rapid mount/unmount and cleanup behavior. Simulate aborts<br>and ensure timers are cleared. For networked actions, inject fakes or pass in<br><code>AbortSignal</code> instances you can abort deterministically. In tests that could<br>schedule intervals, gate timer setup behind environment checks as seen in<br><code>useAuthFetch</code> to avoid runaway timers under <code>vitest</code>.</p>
<h2>Examples from the codebase</h2>
<p>Authentication fetch keeps its API minimal while managing token refresh and<br>timer lifecycle. It exposes a typed <code>authFetch</code> function and tears down its<br>interval on cleanup. Comfy workflow helpers return focused actions and close<br>their <code>EventSource</code> when complete. Gallery scroll returns a small set of<br>functions and signals, and coordinates scrolling via a dedicated manager for<br>smooth behavior.</p>
<p>Refer to these files for concrete, production-grade patterns:</p>
<ul>
<li><code>src/composables/useAuthFetch.ts</code></li>
<li><code>src/composables/useComfy.ts</code></li>
<li><code>src/composables/useDiffusionLLM.ts</code></li>
<li><code>src/composables/useCrawl.ts</code></li>
<li><code>src/composables/useGalleryScroll.tsx</code></li>
</ul>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>