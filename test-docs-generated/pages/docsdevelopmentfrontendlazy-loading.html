<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lazy Loading System - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>Lazy Loading System</h1>
      <div class="markdown-content"><h1>Lazy Loading System</h1>
<p>The lazy loading system is a project-wide solution for managing heavy Python packages that can significantly slow down application startup. It provides a way to import packages only when they are actually needed, allowing the application to start quickly while loading heavy dependencies in the background.</p>
<h2>Overview</h2>
<p>Heavy packages like <code>torch</code>, <code>transformers</code>, <code>tensorflow</code>, <code>sklearn</code>, and <code>tslearn</code> can take several seconds to import, which can make the application startup feel sluggish. The lazy loading system addresses this by:</p>
<ul>
<li><strong>Deferred Loading</strong>: Packages are only imported when first accessed</li>
<li><strong>Background Loading</strong>: Common packages are loaded in the background during startup</li>
<li><strong>Thread Safety</strong>: Multiple threads can safely access the same package</li>
<li><strong>Error Handling</strong>: Graceful fallback when packages are unavailable</li>
<li><strong>Performance Tracking</strong>: Monitor load times and success rates</li>
</ul>
<h2>How It Works</h2>
<h3>Core Components</h3>
<ol>
<li><strong>LazyPackageExport</strong>: A proxy wrapper that only imports the actual package when accessed</li>
<li><strong>LazyLoader</strong>: Central manager that handles multiple packages and background loading</li>
<li><strong>Global Registry</strong>: Pre-registered common packages with aliases</li>
<li><strong>Component Exports</strong>: Specialized exports for common package components (torch.nn, torch.nn.functional, etc.)</li>
</ol>
<h3>Package Registration</h3>
<p>The system pre-registers common heavy packages using <code>LazyPackageExport</code>:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># Pre-registered packages (from app/utils/lazy_loader.py)</span>
torch = LazyPackageExport(<span class="hljs-string">&quot;torch&quot;</span>)
torchvision = LazyPackageExport(<span class="hljs-string">&quot;torchvision&quot;</span>)
transformers = LazyPackageExport(<span class="hljs-string">&quot;transformers&quot;</span>)
timm = LazyPackageExport(<span class="hljs-string">&quot;timm&quot;</span>)
numpy = LazyPackageExport(<span class="hljs-string">&quot;numpy&quot;</span>)
PIL = LazyPackageExport(<span class="hljs-string">&quot;PIL&quot;</span>)
cv2 = LazyPackageExport(<span class="hljs-string">&quot;cv2&quot;</span>)
tensorflow = LazyPackageExport(<span class="hljs-string">&quot;tensorflow&quot;</span>)
sklearn = LazyPackageExport(<span class="hljs-string">&quot;sklearn&quot;</span>)
ultralytics = LazyPackageExport(<span class="hljs-string">&quot;ultralytics&quot;</span>)
safetensors = LazyPackageExport(<span class="hljs-string">&quot;safetensors&quot;</span>)
tslearn = LazyPackageExport(<span class="hljs-string">&quot;tslearn&quot;</span>)
pillow_jxl = LazyPackageExport(<span class="hljs-string">&quot;pillow_jxl&quot;</span>)
pillow_avif = LazyPackageExport(<span class="hljs-string">&quot;pillow_avif&quot;</span>)
einops = LazyPackageExport(<span class="hljs-string">&quot;einops&quot;</span>)
pandas = LazyPackageExport(<span class="hljs-string">&quot;pandas&quot;</span>)
matplotlib = LazyPackageExport(<span class="hljs-string">&quot;matplotlib&quot;</span>)
seaborn = LazyPackageExport(<span class="hljs-string">&quot;seaborn&quot;</span>)

<span class="hljs-comment"># Common component aliases</span>
F = TorchExports()  <span class="hljs-comment"># torch.nn.functional</span>
nn = TorchExports()  <span class="hljs-comment"># torch.nn</span>
checkpoint = TorchExports()  <span class="hljs-comment"># torch.utils.checkpoint</span>
CrossEntropyLoss = TorchExports()  <span class="hljs-comment"># torch.nn.CrossEntropyLoss</span>
rearrange = einops.rearrange  <span class="hljs-comment"># einops.rearrange</span></code></pre><h3>Usage</h3>
<p>Instead of direct imports, use the lazy loading system:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># Before (slow startup)</span>
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModel

<span class="hljs-comment"># After (fast startup)</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> torch, F, transformers

<span class="hljs-comment"># The packages are only loaded when first accessed</span>
model = transformers.AutoModel.from_pretrained(<span class="hljs-string">&quot;bert-base-uncased&quot;</span>)
tensor = torch.tensor([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])
activation = F.relu(tensor)</code></pre><h3>Component Access</h3>
<p>The system provides specialized access to common package components:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> torch, F, nn, checkpoint

<span class="hljs-comment"># These work exactly like the real components</span>
model = nn.Linear(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>)
output = F.relu(model(<span class="hljs-built_in">input</span>))
saved_output = checkpoint.checkpoint(model, <span class="hljs-built_in">input</span>)</code></pre><h3>PIL with Plugin Support</h3>
<p>For image processing, the system provides enhanced PIL access with optional plugin support:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> get_pil_image_with_plugins, check_image_plugin_support

Image = get_pil_image_with_plugins()

<span class="hljs-comment"># Check if JXL/AVIF support is available</span>
<span class="hljs-keyword">if</span> check_image_plugin_support(<span class="hljs-string">&quot;jxl&quot;</span>):
    img = Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;image.jxl&quot;</span>)
<span class="hljs-keyword">elif</span> check_image_plugin_support(<span class="hljs-string">&quot;avif&quot;</span>):
    img = Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;image.avif&quot;</span>)
<span class="hljs-keyword">else</span>:
    img = Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;image.jpg&quot;</span>)</code></pre><h2>Integration Points</h2>
<h3>Application Startup</h3>
<p>The lazy loading system is initialized early in the application startup process:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># In app/main.py</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> initialize_lazy_loading

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-comment"># Initialize lazy loading system first</span>
    t0 = time.time()
    initialize_lazy_loading()
    logger.info(<span class="hljs-string">f&quot;Lazy loading system initialized in <span class="hljs-subst">{time.time() - t0:<span class="hljs-number">.2</span>f}</span>s&quot;</span>)</code></pre><h3>Detection Models</h3>
<p>Detection models use lazy loading for heavy ML packages:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># app/detection_models/yolo_models.py</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> torch, torchvision, transformers, F, nn

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DetectorModelOwl</span>(torch.nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_path: <span class="hljs-built_in">str</span>, dropout: <span class="hljs-built_in">float</span>, n_hidden: <span class="hljs-built_in">int</span> = <span class="hljs-number">768</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        owl = transformers.Owlv2VisionModel.from_pretrained(model_path)
        <span class="hljs-comment"># ...</span></code></pre><h3>Caption Generators</h3>
<p>Caption generation plugins use lazy loading:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># app/caption_generation/plugins/jtp2/generator.py</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> torch, torchvision, safetensors, F, nn

<span class="hljs-keyword">class</span> <span class="hljs-title class_">JTP2Generator</span>(<span class="hljs-title class_ inherited__">CaptionGenerator</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-comment"># Model initialization using lazy-loaded packages</span>
        <span class="hljs-comment"># ...</span></code></pre><h3>Analysis Tools</h3>
<p>Vector analysis and visualization tools use lazy loading:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># app/vector_analysis.py</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> sklearn

<span class="hljs-keyword">def</span> <span class="hljs-title function_">apply_pca</span>(<span class="hljs-params">matrix: pd.DataFrame, n_components: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span></span>) -&gt; pd.DataFrame:
    pca = sklearn.decomposition.PCA(n_components=n_components)
    <span class="hljs-comment"># ...</span></code></pre><h2>API Endpoints</h2>
<h3>Lazy Loading Status</h3>
<p>Monitor the status of lazy loading:</p>
<pre><code class="hljs language-http">GET /api/debug/lazy-loading-status</code></pre><p>Returns:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;progress&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;total_packages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;loaded_packages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">15</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;failed_packages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;is_loading&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;progress_percentage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">83.33</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;packages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;torch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;loaded&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;load_time&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5.804</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;transformers&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;loaded&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;load_time&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.931</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;priority&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span></code></pre><h2>Performance Benefits</h2>
<h3>Startup Time Improvement</h3>
<ul>
<li><strong>Before</strong>: 5-10 seconds startup time due to heavy package imports</li>
<li><strong>After</strong>: 1-2 seconds startup time with background loading</li>
</ul>
<h3>Load Time Examples</h3>
<p>From testing:</p>
<ul>
<li><code>torch</code>: 5.804s (heaviest package)</li>
<li><code>sklearn</code>: 1.456s</li>
<li><code>transformers</code>: 0.931s</li>
<li><code>tslearn</code>: 0.002s</li>
<li><code>numpy</code>: 0.000s (already cached)</li>
<li><code>PIL</code>: 0.000s (already cached)</li>
</ul>
<h3>Background Loading</h3>
<p>Common packages are loaded in the background during startup with priorities:</p>
<ol>
<li><strong>Priority 1</strong> (highest): <code>torch</code>, <code>numpy</code>, <code>PIL</code>, <code>cv2</code>, <code>pygit2</code></li>
<li><strong>Priority 2</strong> (high): <code>transformers</code>, <code>torchvision</code>, <code>timm</code>, <code>pillow_jxl</code>, <code>pillow_avif</code>, <code>watchfiles</code>, <code>sqlalchemy</code></li>
<li><strong>Priority 3</strong> (medium): <code>tensorflow</code>, <code>sklearn</code>, <code>ultralytics</code>, <code>safetensors</code>, <code>tslearn</code></li>
</ol>
<h2>Error Handling</h2>
<p>The system gracefully handles missing packages:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># If a package is not available</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> nonexistent_package

<span class="hljs-comment"># Accessing will raise an ImportError with details</span>
<span class="hljs-keyword">try</span>:
    _ = nonexistent_package.some_attribute
<span class="hljs-keyword">except</span> ImportError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Package not available: <span class="hljs-subst">{e}</span>&quot;</span>)</code></pre><h2>Thread Safety</h2>
<p>The lazy loading system is thread-safe:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># Multiple threads can safely access the same package</span>
<span class="hljs-keyword">import</span> threading

<span class="hljs-keyword">def</span> <span class="hljs-title function_">access_package</span>():
    _ = torch.__version__

threads = [threading.Thread(target=access_package) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
<span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> threads:
    thread.start()
<span class="hljs-keyword">for</span> thread <span class="hljs-keyword">in</span> threads:
    thread.join()
<span class="hljs-comment"># Package is only loaded once, all threads get the same instance</span></code></pre><h2>Testing</h2>
<p>The lazy loading system includes comprehensive tests:</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Run lazy loading tests</span>
python -m pytest app/tests/test_lazy_loader.py -v</code></pre><p>Tests cover:</p>
<ul>
<li>Package initialization</li>
<li>Lazy loading behavior</li>
<li>Thread safety</li>
<li>Error handling</li>
<li>Background loading</li>
<li>Performance tracking</li>
</ul>
<h2>Best Practices</h2>
<h3>When to Use Lazy Loading</h3>
<p>Use lazy loading for:</p>
<ul>
<li>Heavy packages that take &gt;0.1s to import</li>
<li>Packages used in optional features</li>
<li>Packages that may not be available in all environments</li>
<li>Packages used in background tasks</li>
</ul>
<h3>When Not to Use Lazy Loading</h3>
<p>Avoid lazy loading for:</p>
<ul>
<li>Lightweight packages (&lt;0.1s import time)</li>
<li>Core dependencies required for startup</li>
<li>Packages used in critical startup paths</li>
</ul>
<h3>Migration Guide</h3>
<ol>
<li><strong>Identify heavy imports</strong>: Look for <code>import torch</code>, <code>import transformers</code>, etc.</li>
<li><strong>Replace with lazy imports</strong>: Use <code>from app.utils.lazy_loader import torch, transformers</code></li>
<li><strong>Update aliases</strong>: Replace <code>import torch.nn.functional as F</code> with <code>from app.utils.lazy_loader import F</code></li>
<li><strong>Test thoroughly</strong>: Ensure all functionality works with lazy loading</li>
<li><strong>Monitor performance</strong>: Use the status endpoint to track load times</li>
</ol>
<h3>Common Patterns</h3>
<pre><code class="hljs language-python"><span class="hljs-comment"># For torch components</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> torch, F, nn, checkpoint

<span class="hljs-comment"># For transformers</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> transformers

<span class="hljs-comment"># For image processing with plugins</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> get_pil_image_with_plugins, check_image_plugin_support

<span class="hljs-comment"># For data analysis</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> sklearn, pandas, matplotlib, seaborn

<span class="hljs-comment"># For ML models</span>
<span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> torch, torchvision, timm, ultralytics</code></pre><h2>Troubleshooting</h2>
<h3>Common Issues</h3>
<ol>
<li><strong>Import Errors</strong>: Check if the package is properly registered in <code>app/utils/lazy_loader.py</code></li>
<li><strong>Performance Issues</strong>: Monitor load times via the status endpoint</li>
<li><strong>Thread Safety</strong>: Ensure proper locking in custom implementations</li>
<li><strong>Component Access</strong>: Use the correct export class for package components</li>
</ol>
<h3>Debugging</h3>
<p>Use the status endpoint to diagnose issues:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> get_lazy_loading_status

status = get_lazy_loading_status()
<span class="hljs-keyword">for</span> package, info <span class="hljs-keyword">in</span> status[<span class="hljs-string">&quot;packages&quot;</span>].items():
    <span class="hljs-keyword">if</span> info[<span class="hljs-string">&quot;error&quot;</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Error loading <span class="hljs-subst">{package}</span>: <span class="hljs-subst">{info[<span class="hljs-string">&#x27;error&#x27;</span>]}</span>&quot;</span>)</code></pre><h3>Common Error Messages</h3>
<ul>
<li><code>ImportError: Could not import {package_name}</code>: Package not installed or not available</li>
<li><code>AttributeError: &#39;{class}&#39; object has no attribute &#39;{name}&#39;</code>: Component not available in export class</li>
<li><code>ModuleNotFoundError</code>: Package not registered in lazy loader</li>
</ul>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>