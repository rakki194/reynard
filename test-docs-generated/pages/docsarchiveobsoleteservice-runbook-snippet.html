<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Operations Runbook Snippet - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>Service Operations Runbook Snippet</h1>
      <div class="markdown-content"><h1>Service Operations Runbook Snippet</h1>
<p>This document provides operational guidance for interpreting service states, performing restarts, and configuring backoff parameters.</p>
<h2>Service State Interpretation</h2>
<h3>Health States</h3>
<h4>HEALTHY</h4>
<ul>
<li>Service is fully operational</li>
<li>All health checks passing</li>
<li>No recent errors or connection issues</li>
<li><strong>Action</strong>: Monitor normally</li>
</ul>
<h4>DEGRADED</h4>
<ul>
<li>Service is running but experiencing performance issues</li>
<li>May have elevated latency or partial functionality</li>
<li>Connection may be unstable but functional</li>
<li><strong>Action</strong>: Investigate performance issues, check logs for warnings</li>
</ul>
<h4>UNHEALTHY</h4>
<ul>
<li>Service is not functioning properly</li>
<li>Health checks failing consistently</li>
<li>Connection issues or dependency problems</li>
<li><strong>Action</strong>: Immediate investigation required, consider restart</li>
</ul>
<h3>Connection States</h3>
<h4>CONNECTED</h4>
<ul>
<li>Service has established connection to its dependencies</li>
<li>Communication is working normally</li>
<li><strong>Action</strong>: Normal operation</li>
</ul>
<h4>RECONNECTING</h4>
<ul>
<li>Service detected connection loss and is attempting recovery</li>
<li>Backoff retry loop is active</li>
<li><strong>Action</strong>: Monitor reconnection attempts, check dependency health</li>
</ul>
<h4>DISCONNECTED</h4>
<ul>
<li>Service has lost connection and is not attempting recovery</li>
<li>May indicate configuration issues or dependency unavailability</li>
<li><strong>Action</strong>: Check service configuration and dependency status</li>
</ul>
<h2>Restart Guidance</h2>
<h3>When to Restart</h3>
<p><strong>Immediate Restart Required:</strong></p>
<ul>
<li>Service stuck in UNHEALTHY state for &gt; 5 minutes</li>
<li>Service in DISCONNECTED state with no reconnection attempts</li>
<li>Configuration changes that require service restart</li>
</ul>
<p><strong>Consider Restart:</strong></p>
<ul>
<li>Service in DEGRADED state for &gt; 10 minutes</li>
<li>High reconnection attempt rate (&gt; 10 attempts/minute)</li>
<li>Performance issues not resolved by dependency recovery</li>
</ul>
<p><strong>Avoid Restart:</strong></p>
<ul>
<li>Service is HEALTHY and functioning normally</li>
<li>Service is actively reconnecting (RECONNECTING state)</li>
<li>During peak usage periods unless critical</li>
</ul>
<h3>Restart Procedure</h3>
<ol>
<li><p><strong>Pre-restart Checks</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Check current service state</span>
curl -s -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  <span class="hljs-string">&quot;<span class="hljs-variable">$BASE_URL</span>/api/services/health/<span class="hljs-variable">$SERVICE_NAME</span>&quot;</span> | jq

<span class="hljs-comment"># Check service metrics</span>
curl -s -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  <span class="hljs-string">&quot;<span class="hljs-variable">$BASE_URL</span>/api/services/metrics/<span class="hljs-variable">$SERVICE_NAME</span>&quot;</span> | jq</code></pre></li>
<li><p><strong>Perform Restart</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Restart specific service</span>
curl -X POST -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  <span class="hljs-string">&quot;<span class="hljs-variable">$BASE_URL</span>/api/services/restart/<span class="hljs-variable">$SERVICE_NAME</span>&quot;</span></code></pre></li>
<li><p><strong>Post-restart Verification</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Wait 30 seconds, then check health</span>
<span class="hljs-built_in">sleep</span> 30
curl -s -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  <span class="hljs-string">&quot;<span class="hljs-variable">$BASE_URL</span>/api/services/health/<span class="hljs-variable">$SERVICE_NAME</span>&quot;</span> | jq

<span class="hljs-comment"># Monitor for 2-3 minutes to ensure stability</span></code></pre></li>
</ol>
<h3>Service-Specific Restart Notes</h3>
<h4>Comfy Service</h4>
<ul>
<li>Restart may interrupt ongoing image generation</li>
<li>Check for active workflows before restarting</li>
<li>Restart typically takes 10-30 seconds</li>
</ul>
<h4>NLWeb Router Service</h4>
<ul>
<li>Restart may temporarily disable tool suggestions</li>
<li>Cached suggestions may remain available during restart</li>
<li>Restart typically takes 5-15 seconds</li>
</ul>
<h4>VectorDB Service</h4>
<ul>
<li>Restart may interrupt ongoing RAG operations</li>
<li>Database connections will be re-established</li>
<li>Restart typically takes 5-20 seconds</li>
</ul>
<h2>Backoff Configuration Knobs</h2>
<h3>Environment Variables</h3>
<p>All backoff parameters can be configured via environment variables or config file:</p>
<h4>Comfy Service</h4>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Health check interval (seconds)</span>
<span class="hljs-built_in">export</span> COMFY_HEALTH_INTERVAL_S=60

<span class="hljs-comment"># Reconnection parameters</span>
<span class="hljs-built_in">export</span> COMFY_RECONNECT_MAX_ATTEMPTS=5
<span class="hljs-built_in">export</span> COMFY_RECONNECT_BASE_DELAY_S=0.5
<span class="hljs-built_in">export</span> COMFY_RECONNECT_MAX_DELAY_S=30</code></pre><h4>NLWeb Router Service</h4>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Health check interval (seconds)</span>
<span class="hljs-built_in">export</span> NLWEB_HEALTH_INTERVAL_S=120

<span class="hljs-comment"># Reconnection parameters</span>
<span class="hljs-built_in">export</span> NLWEB_RECONNECT_MAX_ATTEMPTS=5
<span class="hljs-built_in">export</span> NLWEB_RECONNECT_BASE_DELAY_MS=200
<span class="hljs-built_in">export</span> NLWEB_RECONNECT_MAX_DELAY_MS=5000</code></pre><h4>VectorDB Service</h4>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Health check interval (seconds)</span>
<span class="hljs-built_in">export</span> PG_HEALTH_INTERVAL_S=60

<span class="hljs-comment"># Reconnection parameters</span>
<span class="hljs-built_in">export</span> PG_RECONNECT_ON_ERROR=<span class="hljs-literal">true</span>
<span class="hljs-built_in">export</span> PG_POOL_PRE_PING=<span class="hljs-literal">true</span></code></pre><h3>Configuration File</h3>
<p>Parameters can also be set in <code>config.json</code>:</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;comfy_health_interval_s&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;comfy_reconnect_max_attempts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;comfy_reconnect_base_delay_s&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;comfy_reconnect_max_delay_s&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">&quot;nlweb_health_interval_s&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">120</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;nlweb_reconnect_max_attempts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;nlweb_reconnect_base_delay_ms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;nlweb_reconnect_max_delay_ms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5000</span><span class="hljs-punctuation">,</span>

  <span class="hljs-attr">&quot;pg_health_interval_s&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;pg_reconnect_on_error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;pg_pool_pre_ping&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span></code></pre><h3>Parameter Tuning Guidelines</h3>
<h4>For High-Availability Environments</h4>
<ul>
<li><strong>Shorter health intervals</strong>: 30-60 seconds for faster failure detection</li>
<li><strong>More reconnection attempts</strong>: 10-15 attempts for persistent recovery</li>
<li><strong>Shorter base delays</strong>: 0.1-0.5 seconds for quick retry</li>
<li><strong>Higher max delays</strong>: 60-120 seconds to handle longer outages</li>
</ul>
<h4>For Resource-Constrained Environments</h4>
<ul>
<li><strong>Longer health intervals</strong>: 120-300 seconds to reduce overhead</li>
<li><strong>Fewer reconnection attempts</strong>: 3-5 attempts to limit resource usage</li>
<li><strong>Longer base delays</strong>: 1-2 seconds to reduce thrashing</li>
<li><strong>Lower max delays</strong>: 10-30 seconds to fail fast</li>
</ul>
<h4>For Development/Testing</h4>
<ul>
<li><strong>Very short intervals</strong>: 10-30 seconds for quick feedback</li>
<li><strong>Minimal attempts</strong>: 2-3 attempts for fast iteration</li>
<li><strong>Short delays</strong>: 0.1-0.5 seconds for immediate retry</li>
</ul>
<h2>Troubleshooting Common Issues</h2>
<h3>Service Stuck in UNHEALTHY State</h3>
<ol>
<li><p><strong>Check dependency health</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Check if dependencies are available</span>
curl -s <span class="hljs-string">&quot;<span class="hljs-variable">$COMFY_API_URL</span>/system_stats&quot;</span>  <span class="hljs-comment"># For Comfy</span>
curl -s <span class="hljs-string">&quot;<span class="hljs-variable">$NLWEB_BASE_URL</span>/status&quot;</span>       <span class="hljs-comment"># For NLWeb</span>
psql <span class="hljs-string">&quot;<span class="hljs-variable">$PG_DSN</span>&quot;</span> -c <span class="hljs-string">&quot;SELECT 1&quot;</span>           <span class="hljs-comment"># For VectorDB</span></code></pre></li>
<li><p><strong>Review service logs</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Check application logs for errors</span>
<span class="hljs-built_in">tail</span> -f logs/app.log | grep -i <span class="hljs-string">&quot;<span class="hljs-variable">$SERVICE_NAME</span>&quot;</span></code></pre></li>
<li><p><strong>Verify configuration</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Check service configuration</span>
curl -s -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  <span class="hljs-string">&quot;<span class="hljs-variable">$BASE_URL</span>/api/services/config/<span class="hljs-variable">$SERVICE_NAME</span>&quot;</span> | jq</code></pre></li>
</ol>
<h3>High Reconnection Attempt Rate</h3>
<ol>
<li><p><strong>Identify the pattern</strong></p>
<ul>
<li>Check if attempts are constant or intermittent</li>
<li>Look for correlation with other services</li>
</ul>
</li>
<li><p><strong>Check network connectivity</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Test basic connectivity</span>
ping <span class="hljs-variable">$DEPENDENCY_HOST</span>
telnet <span class="hljs-variable">$DEPENDENCY_HOST</span> <span class="hljs-variable">$DEPENDENCY_PORT</span></code></pre></li>
<li><p><strong>Review resource usage</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Check system resources</span>
top
<span class="hljs-built_in">df</span> -h
free -h</code></pre></li>
</ol>
<h3>Service Not Starting</h3>
<ol>
<li><p><strong>Check startup logs</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Look for startup errors</span>
<span class="hljs-built_in">tail</span> -f logs/app.log | grep -i <span class="hljs-string">&quot;start.*<span class="hljs-variable">$SERVICE_NAME</span>&quot;</span></code></pre></li>
<li><p><strong>Verify dependencies</strong></p>
<ul>
<li>Ensure all required services are running</li>
<li>Check configuration validity</li>
</ul>
</li>
<li><p><strong>Check resource availability</strong></p>
<ul>
<li>Verify sufficient memory and disk space</li>
<li>Check port availability</li>
</ul>
</li>
</ol>
<h2>Monitoring and Alerting</h2>
<h3>Key Metrics to Monitor</h3>
<ol>
<li><p><strong>Service Health Rate</strong></p>
<pre><code class="hljs"><span class="hljs-comment"># Percentage of healthy services</span>
(sum(yipyap_service_health_state{<span class="hljs-keyword">state</span>=<span class="hljs-string">&quot;healthy&quot;</span>}) / count(yipyap_service_health_state)) * <span class="hljs-number">100</span></code></pre></li>
<li><p><strong>Reconnection Attempt Rate</strong></p>
<pre><code class="hljs"><span class="hljs-comment"># Rate of reconnection attempts per service</span>
<span class="hljs-attribute">rate</span>(yipyap_service_reconnect_attempts_total[<span class="hljs-number">5</span>m])</code></pre></li>
<li><p><strong>Time Since Last OK</strong></p>
<pre><code class="hljs"><span class="hljs-comment"># How long since service was last healthy</span>
<span class="hljs-built_in">time</span>() - yipyap_service_last_ok_seconds</code></pre></li>
</ol>
<h3>Recommended Alerts</h3>
<pre><code class="hljs language-yaml"><span class="hljs-comment"># High priority - immediate attention required</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ServiceUnhealthy</span>
  <span class="hljs-attr">expr:</span> <span class="hljs-string">yipyap_service_health_state{state=&quot;unhealthy&quot;}</span> <span class="hljs-string">==</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;Service <span class="hljs-template-variable">{{ $labels.service }}</span> is unhealthy&quot;</span>

<span class="hljs-comment"># Medium priority - investigate soon</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ServiceDegraded</span>
  <span class="hljs-attr">expr:</span> <span class="hljs-string">yipyap_service_health_state{state=&quot;degraded&quot;}</span> <span class="hljs-string">==</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">for:</span> <span class="hljs-string">10m</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;Service <span class="hljs-template-variable">{{ $labels.service }}</span> is degraded&quot;</span>

<span class="hljs-comment"># Low priority - monitor</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighReconnectionRate</span>
  <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(yipyap_service_reconnect_attempts_total[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">5</span>
  <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">info</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">summary:</span> <span class="hljs-string">&quot;High reconnection rate for <span class="hljs-template-variable">{{ $labels.service }}</span>&quot;</span></code></pre><h2>Emergency Procedures</h2>
<h3>Complete Service Restart</h3>
<p>If individual service restarts are not resolving issues:</p>
<ol>
<li><p><strong>Stop all services</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Stop the application</span>
pkill -f <span class="hljs-string">&quot;python -m app&quot;</span></code></pre></li>
<li><p><strong>Verify clean shutdown</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Check for remaining processes</span>
ps aux | grep -i yipyap</code></pre></li>
<li><p><strong>Restart application</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Restart with proper environment</span>
DEV_PORT=7000 ROOT_DIR=<span class="hljs-variable">$HOME</span>/datasets NODE_ENV=development python -m app</code></pre></li>
<li><p><strong>Monitor startup</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Watch for successful startup</span>
<span class="hljs-built_in">tail</span> -f logs/app.log | grep -i <span class="hljs-string">&quot;started\|ready&quot;</span></code></pre></li>
</ol>
<h3>Configuration Recovery</h3>
<p>If configuration issues are suspected:</p>
<ol>
<li><p><strong>Backup current config</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">cp</span> config/config.json config/config.json.backup.$(<span class="hljs-built_in">date</span> +%Y%m%d_%H%M%S)</code></pre></li>
<li><p><strong>Reset to defaults</strong></p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Remove problematic settings</span>
jq <span class="hljs-string">&#x27;del(.comfy_reconnect_max_attempts, .nlweb_reconnect_max_attempts)&#x27;</span> \
  config/config.json &gt; config/config.json.new
<span class="hljs-built_in">mv</span> config/config.json.new config/config.json</code></pre></li>
<li><p><strong>Apply configuration</strong></p>
<pre><code class="hljs language-bash">curl -X POST -H <span class="hljs-string">&quot;Authorization: Bearer <span class="hljs-variable">$TOKEN</span>&quot;</span> \
  <span class="hljs-string">&quot;<span class="hljs-variable">$BASE_URL</span>/api/services/apply-config&quot;</span></code></pre></li>
</ol>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>