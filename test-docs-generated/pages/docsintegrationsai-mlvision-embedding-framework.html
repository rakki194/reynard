<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vision Embedding Framework - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>Vision Embedding Framework</h1>
      <div class="markdown-content"><h1>Vision Embedding Framework</h1>
<p>The Vision Embedding Framework provides a unified interface for managing vision embedding services with automatic memory management, model unloading, and service lifecycle handling. This framework enables easy integration of new vision embedding services while maintaining consistent behavior across all implementations.</p>
<h2>Overview</h2>
<p>The framework consists of three main components:</p>
<ol>
<li><strong>VisionEmbeddingService</strong> - Base class for all vision embedding services</li>
<li><strong>VisionEmbeddingRegistry</strong> - Service registry for discovery and management</li>
<li><strong>VisionEmbeddingUnloader</strong> - Unified unloading interface for memory management</li>
</ol>
<h2>Architecture</h2>
<pre><code class="hljs">VisionEmbeddingService (Base Class)
├── Model Management
│   ├── Loading/Unloading
│   ├── Multi-model support
│   └── Memory<span class="hljs-built_in"> tracking
</span>├── Embedding Generation
│   ├── Batch processing
│   ├── Detailed results
│   └── <span class="hljs-built_in">Error</span> handling
└──<span class="hljs-built_in"> Service </span>Lifecycle
    ├── Initialization
    ├──<span class="hljs-built_in"> Health </span>checks
    └── Shutdown

VisionEmbeddingRegistry
├──<span class="hljs-built_in"> Service </span>Registration
├──<span class="hljs-built_in"> Instance </span>Management
├── Model<span class="hljs-built_in"> Discovery
</span>└── Status Monitoring

VisionEmbeddingUnloader
├── Unified Unloading
├── Memory Pressure Detection
├── Timeout-based Unloading
└── LRU-based Unloading</code></pre><h2>Quick Start</h2>
<h3>1. Create a Vision Embedding Service</h3>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.services.integration.vision_embedding_service <span class="hljs-keyword">import</span> VisionEmbeddingService
<span class="hljs-keyword">from</span> app.services.integration.vision_embedding_registry <span class="hljs-keyword">import</span> register_vision_embedding_service

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyVisionEmbeddingService</span>(<span class="hljs-title class_ inherited__">VisionEmbeddingService</span>):
    <span class="hljs-comment"># Define your model registry</span>
    MODEL_REGISTRY = {
        <span class="hljs-string">&quot;my-model-1&quot;</span>: {
            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;My Model 1&quot;</span>,
            <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;My custom vision model&quot;</span>,
            <span class="hljs-string">&quot;embed_dim&quot;</span>: <span class="hljs-number">512</span>,
            <span class="hljs-string">&quot;preprocess_size&quot;</span>: <span class="hljs-number">224</span>,
            <span class="hljs-string">&quot;memory_estimate_gb&quot;</span>: <span class="hljs-number">1.0</span>,
            <span class="hljs-string">&quot;performance_rating&quot;</span>: <span class="hljs-string">&quot;balanced&quot;</span>,
            <span class="hljs-string">&quot;recommended_use&quot;</span>: <span class="hljs-string">&quot;general purpose&quot;</span>,
        }
    }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__(
            name=<span class="hljs-string">&quot;my_vision_embedding_service&quot;</span>,
            dependencies=[<span class="hljs-string">&quot;config_manager&quot;</span>],
            required_packages=[<span class="hljs-string">&quot;torch&quot;</span>, <span class="hljs-string">&quot;transformers&quot;</span>],
            startup_priority=<span class="hljs-number">5</span>,
            health_check_interval=<span class="hljs-number">60</span>,
            auto_start=<span class="hljs-literal">True</span>,
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_valid_model</span>(<span class="hljs-params">self, model_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">&quot;&quot;&quot;Check if a model ID is valid.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> model_id <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.MODEL_REGISTRY

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_load_specific_model</span>(<span class="hljs-params">self, model_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">&quot;&quot;&quot;Load your specific model implementation.&quot;&quot;&quot;</span>
        <span class="hljs-comment"># Your model loading logic here</span>
        model_info = <span class="hljs-variable language_">self</span>.MODEL_REGISTRY[model_id]
        <span class="hljs-variable language_">self</span>._current_model_id = model_id
        <span class="hljs-variable language_">self</span>._model_loaded = <span class="hljs-literal">True</span>
        <span class="hljs-variable language_">self</span>._embed_dim = model_info[<span class="hljs-string">&quot;embed_dim&quot;</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_unload_specific_model</span>(<span class="hljs-params">self, model_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">&quot;&quot;&quot;Unload your specific model implementation.&quot;&quot;&quot;</span>
        <span class="hljs-comment"># Your model unloading logic here</span>
        <span class="hljs-keyword">if</span> model_id == <span class="hljs-variable language_">self</span>._current_model_id:
            <span class="hljs-variable language_">self</span>._current_model_id = <span class="hljs-string">&quot;&quot;</span>
            <span class="hljs-variable language_">self</span>._model_loaded = <span class="hljs-literal">False</span>
            <span class="hljs-variable language_">self</span>._embed_dim = <span class="hljs-number">0</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_embed_batch</span>(<span class="hljs-params">self, image_paths: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], variant: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]]:
        <span class="hljs-string">&quot;&quot;&quot;Generate embeddings for a batch of images.&quot;&quot;&quot;</span>
        <span class="hljs-comment"># Your embedding generation logic here</span>
        embeddings = []
        <span class="hljs-keyword">for</span> image_path <span class="hljs-keyword">in</span> image_paths:
            <span class="hljs-comment"># Process image and generate embedding</span>
            embedding = <span class="hljs-variable language_">self</span>._generate_embedding(image_path)
            embeddings.append(embedding)
        <span class="hljs-keyword">return</span> embeddings

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_embed_batch_detailed</span>(<span class="hljs-params">self, image_paths: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], batch_size: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">&quot;&quot;&quot;Generate embeddings with detailed per-image results.&quot;&quot;&quot;</span>
        results = []
        <span class="hljs-keyword">for</span> image_path <span class="hljs-keyword">in</span> image_paths:
            <span class="hljs-keyword">try</span>:
                embedding = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">self</span>._embed_batch([image_path], <span class="hljs-string">&quot;default&quot;</span>)
                results.append({
                    <span class="hljs-string">&quot;path&quot;</span>: image_path,
                    <span class="hljs-string">&quot;variant&quot;</span>: <span class="hljs-string">&quot;default&quot;</span>,
                    <span class="hljs-string">&quot;embedding&quot;</span>: embedding[<span class="hljs-number">0</span>],
                    <span class="hljs-string">&quot;model_id&quot;</span>: <span class="hljs-variable language_">self</span>._current_model_id,
                    <span class="hljs-string">&quot;embed_dim&quot;</span>: <span class="hljs-variable language_">self</span>._embed_dim,
                })
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                results.append({
                    <span class="hljs-string">&quot;path&quot;</span>: image_path,
                    <span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-built_in">str</span>(e),
                })
        <span class="hljs-keyword">return</span> results

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_default_model_id</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Get the default model ID.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;my-model-1&quot;</span>

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_model_info</span>(<span class="hljs-params">self, model_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">&quot;&quot;&quot;Get information about a specific model.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">if</span> model_id <span class="hljs-keyword">in</span> <span class="hljs-variable language_">self</span>.MODEL_REGISTRY:
            info = <span class="hljs-variable language_">self</span>.MODEL_REGISTRY[model_id].copy()
            info.update({
                <span class="hljs-string">&quot;model_id&quot;</span>: model_id,
                <span class="hljs-string">&quot;loaded_at&quot;</span>: time.time(),
                <span class="hljs-string">&quot;last_used&quot;</span>: time.time(),
                <span class="hljs-string">&quot;service_name&quot;</span>: <span class="hljs-variable language_">self</span>.name,
            })
            <span class="hljs-keyword">return</span> info
        <span class="hljs-keyword">return</span> {}

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_available_models</span>(<span class="hljs-params">cls</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">&quot;&quot;&quot;Get list of available models.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> [
            {
                <span class="hljs-string">&quot;id&quot;</span>: model_id,
                <span class="hljs-string">&quot;name&quot;</span>: info[<span class="hljs-string">&quot;name&quot;</span>],
                <span class="hljs-string">&quot;description&quot;</span>: info[<span class="hljs-string">&quot;description&quot;</span>],
                <span class="hljs-string">&quot;embed_dim&quot;</span>: info[<span class="hljs-string">&quot;embed_dim&quot;</span>],
                <span class="hljs-string">&quot;preprocess_size&quot;</span>: info[<span class="hljs-string">&quot;preprocess_size&quot;</span>],
                <span class="hljs-string">&quot;memory_estimate_gb&quot;</span>: info[<span class="hljs-string">&quot;memory_estimate_gb&quot;</span>],
                <span class="hljs-string">&quot;performance_rating&quot;</span>: info[<span class="hljs-string">&quot;performance_rating&quot;</span>],
                <span class="hljs-string">&quot;recommended_use&quot;</span>: info[<span class="hljs-string">&quot;recommended_use&quot;</span>],
            }
            <span class="hljs-keyword">for</span> model_id, info <span class="hljs-keyword">in</span> cls.MODEL_REGISTRY.items()
        ]

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_model_info</span>(<span class="hljs-params">cls, model_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">&quot;&quot;&quot;Get detailed information about a specific model.&quot;&quot;&quot;</span>
        <span class="hljs-keyword">return</span> cls.MODEL_REGISTRY.get(model_id)

<span class="hljs-comment"># Register your service</span>
register_vision_embedding_service(
    MyVisionEmbeddingService,
    name=<span class="hljs-string">&quot;my_vision_embedding&quot;</span>,
    metadata={
        <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;My custom vision embedding service&quot;</span>,
        <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;1.0.0&quot;</span>,
        <span class="hljs-string">&quot;author&quot;</span>: <span class="hljs-string">&quot;Your Name&quot;</span>,
        <span class="hljs-string">&quot;tags&quot;</span>: [<span class="hljs-string">&quot;vision&quot;</span>, <span class="hljs-string">&quot;embedding&quot;</span>, <span class="hljs-string">&quot;custom&quot;</span>],
    }
)</code></pre><h3>2. Using the Service</h3>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.services.integration.vision_embedding_registry <span class="hljs-keyword">import</span> get_vision_embedding_registry

<span class="hljs-comment"># Get the registry</span>
registry = get_vision_embedding_registry()

<span class="hljs-comment"># Create an instance</span>
service = registry.create_service_instance(<span class="hljs-string">&quot;my_vision_embedding&quot;</span>)

<span class="hljs-comment"># Load a model</span>
<span class="hljs-keyword">await</span> service.load_model(<span class="hljs-string">&quot;my-model-1&quot;</span>)

<span class="hljs-comment"># Generate embeddings</span>
image_paths = [<span class="hljs-string">&quot;image1.jpg&quot;</span>, <span class="hljs-string">&quot;image2.jpg&quot;</span>]
embeddings = <span class="hljs-keyword">await</span> service.embed_images(image_paths)

<span class="hljs-comment"># Get detailed results</span>
detailed_results = <span class="hljs-keyword">await</span> service.embed_images_detailed(image_paths)

<span class="hljs-comment"># Unload the model</span>
<span class="hljs-keyword">await</span> service.unload_model(<span class="hljs-string">&quot;my-model-1&quot;</span>)</code></pre><h3>3. Using the Unified Unloading Interface</h3>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.services.integration.vision_embedding_unloader <span class="hljs-keyword">import</span> (
    unload_all_vision_embedding_models,
    unload_vision_embedding_service_models,
    unload_vision_embedding_model,
    unload_vision_embedding_models_by_memory_pressure,
    unload_vision_embedding_models_by_timeout,
)

<span class="hljs-comment"># Unload all models from all services</span>
results = <span class="hljs-keyword">await</span> unload_all_vision_embedding_models()

<span class="hljs-comment"># Unload all models from a specific service</span>
success = <span class="hljs-keyword">await</span> unload_vision_embedding_service_models(<span class="hljs-string">&quot;my_vision_embedding&quot;</span>)

<span class="hljs-comment"># Unload a specific model</span>
success = <span class="hljs-keyword">await</span> unload_vision_embedding_model(<span class="hljs-string">&quot;my_vision_embedding&quot;</span>, <span class="hljs-string">&quot;my-model-1&quot;</span>)

<span class="hljs-comment"># Unload based on memory pressure</span>
results = <span class="hljs-keyword">await</span> unload_vision_embedding_models_by_memory_pressure(threshold=<span class="hljs-number">0.85</span>)

<span class="hljs-comment"># Unload based on timeout</span>
results = <span class="hljs-keyword">await</span> unload_vision_embedding_models_by_timeout(vram_timeout=<span class="hljs-number">600</span>, ram_timeout=<span class="hljs-number">1800</span>)</code></pre><h2>Key Features</h2>
<h3>1. Automatic Memory Management</h3>
<p>The framework integrates with the existing <code>ModelUsageTracker</code> to automatically unload models based on:</p>
<ul>
<li><strong>VRAM Timeout</strong>: Models are unloaded after a configurable time of inactivity (default: 10 minutes)</li>
<li><strong>RAM Timeout</strong>: Models are unloaded after a longer period of inactivity (default: 30 minutes)</li>
<li><strong>Memory Pressure</strong>: Models are unloaded when memory usage exceeds thresholds</li>
<li><strong>LRU Policy</strong>: Least recently used models are unloaded when new models need to be loaded</li>
</ul>
<h3>2. Multi-Model Support</h3>
<p>Services can support multiple models with:</p>
<ul>
<li><strong>Concurrent Loading</strong>: Multiple models can be loaded simultaneously (configurable limit)</li>
<li><strong>Model Switching</strong>: Easy switching between different models</li>
<li><strong>Model Registry</strong>: Centralized model information and metadata</li>
<li><strong>Memory Tracking</strong>: Per-model memory usage tracking</li>
</ul>
<h3>3. Unified Interface</h3>
<p>All vision embedding services provide the same interface:</p>
<ul>
<li><strong>Standardized API</strong>: Consistent methods across all services</li>
<li><strong>Error Handling</strong>: Robust error handling and recovery</li>
<li><strong>Health Monitoring</strong>: Built-in health checks and status reporting</li>
<li><strong>Service Discovery</strong>: Automatic service registration and discovery</li>
</ul>
<h3>4. Service Lifecycle Management</h3>
<p>Complete lifecycle management including:</p>
<ul>
<li><strong>Initialization</strong>: Proper service initialization with dependency checking</li>
<li><strong>Health Checks</strong>: Regular health monitoring and status reporting</li>
<li><strong>Graceful Shutdown</strong>: Proper cleanup and resource management</li>
<li><strong>Dependency Management</strong>: Automatic dependency resolution and startup ordering</li>
</ul>
<h2>Configuration</h2>
<h3>Service Configuration</h3>
<pre><code class="hljs language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyVisionEmbeddingService</span>(<span class="hljs-title class_ inherited__">VisionEmbeddingService</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__(
            name=<span class="hljs-string">&quot;my_vision_embedding_service&quot;</span>,  <span class="hljs-comment"># Unique service name</span>
            dependencies=[<span class="hljs-string">&quot;config_manager&quot;</span>],     <span class="hljs-comment"># Required dependencies</span>
            required_packages=[<span class="hljs-string">&quot;torch&quot;</span>],         <span class="hljs-comment"># Required Python packages</span>
            startup_priority=<span class="hljs-number">5</span>,                  <span class="hljs-comment"># Startup priority (lower = higher)</span>
            health_check_interval=<span class="hljs-number">60</span>,            <span class="hljs-comment"># Health check interval in seconds</span>
            auto_start=<span class="hljs-literal">True</span>,                     <span class="hljs-comment"># Auto-start when dependencies are ready</span>
        )</code></pre><h3>Model Registry Configuration</h3>
<pre><code class="hljs language-python">MODEL_REGISTRY = {
    <span class="hljs-string">&quot;model-id&quot;</span>: {
        <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Model Name&quot;</span>,                    <span class="hljs-comment"># Human-readable name</span>
        <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Model description&quot;</span>,      <span class="hljs-comment"># Detailed description</span>
        <span class="hljs-string">&quot;embed_dim&quot;</span>: <span class="hljs-number">512</span>,                        <span class="hljs-comment"># Embedding dimension</span>
        <span class="hljs-string">&quot;preprocess_size&quot;</span>: <span class="hljs-number">224</span>,                  <span class="hljs-comment"># Input image size</span>
        <span class="hljs-string">&quot;memory_estimate_gb&quot;</span>: <span class="hljs-number">1.0</span>,               <span class="hljs-comment"># Estimated memory usage</span>
        <span class="hljs-string">&quot;performance_rating&quot;</span>: <span class="hljs-string">&quot;balanced&quot;</span>,        <span class="hljs-comment"># Performance rating</span>
        <span class="hljs-string">&quot;recommended_use&quot;</span>: <span class="hljs-string">&quot;general purpose&quot;</span>,    <span class="hljs-comment"># Recommended use case</span>
    }
}</code></pre><h2>Integration with Existing Services</h2>
<p>The framework is designed to integrate seamlessly with existing services:</p>
<h3>1. ModelUsageTracker Integration</h3>
<pre><code class="hljs language-python"><span class="hljs-comment"># Automatic integration with ModelUsageTracker</span>
<span class="hljs-keyword">from</span> app.managers.model_usage_tracker <span class="hljs-keyword">import</span> get_model_usage_tracker

tracker = get_model_usage_tracker()
tracker.record_usage(model_id)  <span class="hljs-comment"># Record model usage</span>
tracker.mark_unloaded(model_id)  <span class="hljs-comment"># Mark model as unloaded</span></code></pre><h3>2. Service Manager Integration</h3>
<pre><code class="hljs language-python"><span class="hljs-comment"># Register with service manager</span>
<span class="hljs-keyword">from</span> app.services.core.service_setup <span class="hljs-keyword">import</span> get_service_manager

service_manager = get_service_manager()
service_manager.register_service(my_vision_embedding_service)</code></pre><h3>3. API Integration</h3>
<pre><code class="hljs language-python"><span class="hljs-comment"># Use in API endpoints</span>
<span class="hljs-keyword">from</span> app.services.integration.vision_embedding_registry <span class="hljs-keyword">import</span> get_vision_embedding_registry

registry = get_vision_embedding_registry()
service = registry.get_service_instance(<span class="hljs-string">&quot;my_vision_embedding&quot;</span>)
embeddings = <span class="hljs-keyword">await</span> service.embed_images(image_paths)</code></pre><h2>Best Practices</h2>
<h3>1. Model Implementation</h3>
<ul>
<li><strong>Lazy Loading</strong>: Load models only when needed</li>
<li><strong>Memory Management</strong>: Properly clean up model resources</li>
<li><strong>Error Handling</strong>: Handle loading/unloading errors gracefully</li>
<li><strong>Validation</strong>: Validate model IDs and parameters</li>
</ul>
<h3>2. Service Implementation</h3>
<ul>
<li><strong>Dependency Management</strong>: Declare all required dependencies</li>
<li><strong>Health Checks</strong>: Implement meaningful health checks</li>
<li><strong>Error Recovery</strong>: Provide error recovery mechanisms</li>
<li><strong>Logging</strong>: Use appropriate logging levels</li>
</ul>
<h3>3. Registry Usage</h3>
<ul>
<li><strong>Service Registration</strong>: Register services with descriptive metadata</li>
<li><strong>Instance Management</strong>: Use the registry for instance management</li>
<li><strong>Discovery</strong>: Use registry methods for service discovery</li>
<li><strong>Cleanup</strong>: Properly unregister services when no longer needed</li>
</ul>
<h3>4. Unloading Strategy</h3>
<ul>
<li><strong>Proactive Unloading</strong>: Unload models before memory pressure</li>
<li><strong>Timeout Configuration</strong>: Configure appropriate timeouts</li>
<li><strong>Monitoring</strong>: Monitor unloading events and performance</li>
<li><strong>Fallback</strong>: Provide fallback mechanisms for unloading failures</li>
</ul>
<h2>Testing</h2>
<h3>Unit Testing</h3>
<pre><code class="hljs language-python"><span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">from</span> unittest.mock <span class="hljs-keyword">import</span> AsyncMock, MagicMock

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMyVisionEmbeddingService</span>:
<span class="hljs-meta">    @pytest.fixture</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">service</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> MyVisionEmbeddingService()

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_model_loading</span>(<span class="hljs-params">self, service</span>):
        <span class="hljs-keyword">await</span> service.initialize()
        success = <span class="hljs-keyword">await</span> service.load_model(<span class="hljs-string">&quot;my-model-1&quot;</span>)
        <span class="hljs-keyword">assert</span> success <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">assert</span> service.is_model_loaded <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span>

<span class="hljs-meta">    @pytest.mark.asyncio</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_embedding_generation</span>(<span class="hljs-params">self, service</span>):
        <span class="hljs-keyword">await</span> service.initialize()
        <span class="hljs-keyword">await</span> service.load_model(<span class="hljs-string">&quot;my-model-1&quot;</span>)
        embeddings = <span class="hljs-keyword">await</span> service.embed_images([<span class="hljs-string">&quot;test.jpg&quot;</span>])
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(embeddings) == <span class="hljs-number">1</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(embeddings[<span class="hljs-number">0</span>]) == <span class="hljs-number">512</span></code></pre><h3>Integration Testing</h3>
<pre><code class="hljs language-python"><span class="hljs-meta">@pytest.mark.asyncio</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_service_registration</span>():
    registry = get_vision_embedding_registry()
    registry.register_service(MyVisionEmbeddingService)
    <span class="hljs-keyword">assert</span> <span class="hljs-string">&quot;my_vision_embedding&quot;</span> <span class="hljs-keyword">in</span> registry.get_registered_services()

<span class="hljs-meta">@pytest.mark.asyncio</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_unified_unloading</span>():
    results = <span class="hljs-keyword">await</span> unload_all_vision_embedding_models()
    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(results, <span class="hljs-built_in">dict</span>)</code></pre><h2>Troubleshooting</h2>
<h3>Common Issues</h3>
<ol>
<li><p><strong>Model Loading Failures</strong></p>
<ul>
<li>Check required packages are installed</li>
<li>Verify model files are accessible</li>
<li>Check memory availability</li>
</ul>
</li>
<li><p><strong>Service Registration Issues</strong></p>
<ul>
<li>Ensure service inherits from VisionEmbeddingService</li>
<li>Verify all abstract methods are implemented</li>
<li>Check service name uniqueness</li>
</ul>
</li>
<li><p><strong>Memory Management Issues</strong></p>
<ul>
<li>Monitor memory usage patterns</li>
<li>Adjust timeout configurations</li>
<li>Check for memory leaks in model implementations</li>
</ul>
</li>
<li><p><strong>Performance Issues</strong></p>
<ul>
<li>Profile model loading/unloading times</li>
<li>Optimize batch processing</li>
<li>Consider model caching strategies</li>
</ul>
</li>
</ol>
<h3>Debugging</h3>
<pre><code class="hljs language-python"><span class="hljs-comment"># Enable debug logging</span>
<span class="hljs-keyword">import</span> logging
logging.getLogger(<span class="hljs-string">&quot;uvicorn&quot;</span>).setLevel(logging.DEBUG)

<span class="hljs-comment"># Check service status</span>
registry = get_vision_embedding_registry()
status = registry.get_service_status()
<span class="hljs-built_in">print</span>(status)

<span class="hljs-comment"># Check model information</span>
models = registry.get_available_models()
<span class="hljs-built_in">print</span>(models)</code></pre><h2>Future Enhancements</h2>
<p>The framework is designed to be extensible and can be enhanced with:</p>
<ol>
<li><strong>Model Compression</strong>: Automatic model compression for inactive models</li>
<li><strong>Distributed Loading</strong>: Support for distributed model loading across multiple nodes</li>
<li><strong>Advanced Caching</strong>: Intelligent model caching with predictive loading</li>
<li><strong>Performance Optimization</strong>: Advanced performance monitoring and optimization</li>
<li><strong>Plugin System</strong>: Plugin-based architecture for easy service extension</li>
</ol>
<h2>Conclusion</h2>
<p>The Vision Embedding Framework provides a robust, extensible foundation for vision embedding services with automatic memory management, unified interfaces, and comprehensive lifecycle management. By following the patterns and best practices outlined in this documentation, you can easily create new vision embedding services that integrate seamlessly with the existing system.</p>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>