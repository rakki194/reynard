<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plugin Service Integration - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>Plugin Service Integration</h1>
      <div class="markdown-content"><h1>Plugin Service Integration</h1>
<p>This document describes the integration of ultralytics, pillow-jxl, and pillow-avif plugins into the service management system and lazy loading stack.</p>
<h2>Overview</h2>
<p>The plugin dependencies (ultralytics, pillow-jxl, pillow-avif) have been moved from direct imports to a service-based management system that provides:</p>
<ul>
<li><strong>Lazy loading</strong> - Plugins are loaded only when needed</li>
<li><strong>Service management</strong> - Centralized plugin availability detection and management</li>
<li><strong>Backward compatibility</strong> - Existing code continues to work with fallback mechanisms</li>
<li><strong>Health monitoring</strong> - Service health checks for plugin availability</li>
<li><strong>Proper error handling</strong> - Graceful degradation when plugins are not available</li>
</ul>
<h2>Services Implemented</h2>
<h3>ImageProcessingService</h3>
<p><strong>Location</strong>: <code>app/services/image_processing.py</code></p>
<p><strong>Purpose</strong>: Manages image processing capabilities including pillow-jxl and pillow-avif plugin support.</p>
<p><strong>Features</strong>:</p>
<ul>
<li>Detects pillow-jxl and pillow-avif availability at startup</li>
<li>Provides supported image formats information</li>
<li>Health checks for plugin availability</li>
<li>Service information with plugin status</li>
</ul>
<p><strong>Key Methods</strong>:</p>
<ul>
<li><code>is_jxl_supported()</code> - Check if JXL format is supported</li>
<li><code>is_avif_supported()</code> - Check if AVIF format is supported</li>
<li><code>get_supported_formats()</code> - Get set of supported image formats</li>
<li><code>get_format_info()</code> - Get detailed information about supported formats</li>
<li><code>get_supported_formats_for_inference()</code> - Get MIME types used by inference workflows</li>
<li><code>get_pil_image()</code> / <code>get_pil_imagedraw()</code> / <code>get_pil_imagefont()</code> - Safe accessors for Pillow modules respecting plugin state</li>
</ul>
<p><strong>Usage</strong>:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.services.access <span class="hljs-keyword">import</span> get_image_processing

image_service = get_image_processing()
<span class="hljs-keyword">if</span> image_service.is_jxl_supported():
    <span class="hljs-comment"># Process JXL images</span>
    <span class="hljs-keyword">pass</span></code></pre><p>Additional details from implementation:</p>
<ul>
<li>Startup priority: 2 (early) and <code>required_packages=[&quot;PIL&quot;]</code></li>
<li>Health checks every 60s update plugin availability at runtime</li>
<li><code>get_info()</code> includes <code>pillow_jxl_available</code>, <code>pillow_avif_available</code>, <code>supported_formats</code>, <code>format_info</code></li>
</ul>
<p>Code reference:</p>
<pre><code class="hljs"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_initialize_supported_formats</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span></span>) -&gt; <span class="hljs-title class_">None</span>:
    <span class="hljs-comment"># ... adds standard formats, then conditionally adds .jxl and .avif when plugins are present</span>
    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.<span class="hljs-symbol">_pillow_jxl_available:</span>
        <span class="hljs-variable language_">self</span>._supported_formats.add(<span class="hljs-string">&quot;.jxl&quot;</span>)
        <span class="hljs-variable language_">self</span>._format_info[<span class="hljs-string">&quot;.jxl&quot;</span>] = {<span class="hljs-string">&quot;plugin_name&quot;</span>: <span class="hljs-string">&quot;pillow-jxl&quot;</span>, ...}
    <span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.<span class="hljs-symbol">_pillow_avif_available:</span>
        <span class="hljs-variable language_">self</span>._supported_formats.add(<span class="hljs-string">&quot;.avif&quot;</span>)
        <span class="hljs-variable language_">self</span>._format_info[<span class="hljs-string">&quot;.avif&quot;</span>] = {<span class="hljs-string">&quot;plugin_name&quot;</span>: <span class="hljs-string">&quot;pillow-avif&quot;</span>, ...}</code></pre><h3>DetectionModelsService (Enhanced)</h3>
<p><strong>Location</strong>: <code>app/services/detection_models.py</code></p>
<p><strong>Purpose</strong>: Enhanced to include ultralytics availability detection for YOLO models.</p>
<p><strong>New Features</strong>:</p>
<ul>
<li>Detects ultralytics availability at startup</li>
<li>Provides ultralytics availability status</li>
<li>Enhanced service information with ultralytics status</li>
</ul>
<p><strong>Key Methods</strong>:</p>
<ul>
<li><code>is_ultralytics_available()</code> - Check if ultralytics is available for YOLO models</li>
<li><code>get_available_models()</code> / <code>list_available_models()</code> - Discovery of registered detection models</li>
<li><code>load_model(model_id)</code> / <code>unload_model(model_id)</code> - Async lifecycle helpers</li>
<li><code>get_info()</code> includes <code>ultralytics_available</code> and model counts</li>
</ul>
<p><strong>Usage</strong>:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.services.access <span class="hljs-keyword">import</span> get_detection_models

detection_service = get_detection_models()
<span class="hljs-keyword">if</span> detection_service.is_ultralytics_available():
    <span class="hljs-comment"># Use YOLO models</span>
    <span class="hljs-keyword">pass</span></code></pre><p>Additional details from implementation:</p>
<ul>
<li>Startup priority: 7 and <code>required_packages=[&quot;torch&quot;, &quot;torchvision&quot;]</code></li>
<li>Ultralytics detection uses lazy export; absence is handled gracefully</li>
</ul>
<p>Code reference:</p>
<pre><code class="hljs"><span class="hljs-comment"># Check for ultralytics availability</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> ultralytics
    YOLO = ultralytics.YOLO
    <span class="hljs-variable language_">self</span>._ultralytics_available = <span class="hljs-literal">True</span>
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-variable language_">self</span>._ultralytics_available = <span class="hljs-literal">False</span></code></pre><h2>Lazy Loader Integration</h2>
<h3>New Package Registrations</h3>
<p>The following packages have been added to the lazy loader:</p>
<ul>
<li><code>pillow_jxl</code> - Priority 2 (high priority for image processing)</li>
<li><code>pillow_avif</code> - Priority 2 (high priority for image processing)</li>
<li><code>ultralytics</code> - Priority 3 (medium priority for ML models)</li>
</ul>
<h3>Lazy Exports</h3>
<p>New lazy exports have been added:</p>
<pre><code class="hljs language-python">pillow_jxl = LazyPackageExport(<span class="hljs-string">&quot;pillow_jxl&quot;</span>)
pillow_avif = LazyPackageExport(<span class="hljs-string">&quot;pillow_avif&quot;</span>)</code></pre><h3>Helper utilities</h3>
<p>The lazy loader also exposes helpers that consult <code>ImageProcessingService</code> when available and fall back to direct imports:</p>
<ul>
<li><code>get_pil_image_with_plugins()</code></li>
<li><code>get_pil_imagedraw()</code></li>
<li><code>get_pil_imagefont()</code></li>
<li><code>check_image_plugin_support(plugin_name: Literal[&quot;jxl&quot;|&quot;avif&quot;])</code></li>
<li><code>get_supported_image_formats()</code> (MIME list for inference)</li>
</ul>
<p>Example:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> get_pil_image_with_plugins, check_image_plugin_support

Image = get_pil_image_with_plugins()
<span class="hljs-keyword">if</span> check_image_plugin_support(<span class="hljs-string">&quot;avif&quot;</span>):
    img = Image.<span class="hljs-built_in">open</span>(path_to_avif)</code></pre><p>Initialization (optional):</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> initialize_lazy_loading
loader = initialize_lazy_loading()
<span class="hljs-keyword">await</span> loader.start_background_loading()</code></pre><h2>Backward Compatibility</h2>
<h3>Image Format Detection</h3>
<p>The <code>get_supported_image_formats()</code> function in <code>app/caption_generation/utils.py</code> has been updated to:</p>
<ol>
<li>First try to get formats from the ImageProcessingService</li>
<li>Fall back to direct plugin checks if the service is not available</li>
<li>Maintain the same return format and behavior</li>
</ol>
<h3>YOLO Models</h3>
<p>The YOLO models in <code>app/detection_models/yolo_models.py</code> have been updated to:</p>
<ol>
<li>First try to get ultralytics availability from the DetectionModelsService</li>
<li>Fall back to direct checks if the service is not available</li>
<li>Maintain the same behavior and error handling</li>
</ol>
<p>Code reference:</p>
<pre><code class="hljs"><span class="hljs-keyword">from</span> app.utils.lazy_loader <span class="hljs-keyword">import</span> ultralytics
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">from</span> app.services.access <span class="hljs-keyword">import</span> get_detection_models
    detection_models_service = get_detection_models()
    <span class="hljs-keyword">if</span> detection_models_service <span class="hljs-keyword">and</span> detection_models_service.status.value == <span class="hljs-string">&quot;running&quot;</span>:
        ULTRALYTICS_AVAILABLE = detection_models_service.is_ultralytics_available()
    <span class="hljs-keyword">else</span>:
        YOLO = ultralytics.YOLO
        ULTRALYTICS_AVAILABLE = <span class="hljs-literal">True</span>
<span class="hljs-keyword">except</span> (RuntimeError, ImportError):
    <span class="hljs-keyword">try</span>:
        YOLO = ultralytics.YOLO
        ULTRALYTICS_AVAILABLE = <span class="hljs-literal">True</span>
    <span class="hljs-keyword">except</span> ImportError:
        ULTRALYTICS_AVAILABLE = <span class="hljs-literal">False</span></code></pre><h2>Service Integration</h2>
<h3>Core Service Setup</h3>
<p>Both new services are integrated into the core service setup in <code>app/services/core/service_setup.py</code>:</p>
<ul>
<li>ImageProcessingService is registered with startup priority 2 (early startup)</li>
<li>DetectionModelsService is enhanced with ultralytics detection</li>
<li>Both services are properly registered with the service manager</li>
</ul>
<p>Registration reference:</p>
<pre><code class="hljs">_service_manager<span class="hljs-selector-class">.register_service</span>(caption_generator_service)
_service_manager<span class="hljs-selector-class">.register_service</span>(detection_models_service)
_service_manager<span class="hljs-selector-class">.register_service</span>(image_processing_service)</code></pre><h3>Service Access</h3>
<p>New service access functions have been added to <code>app/services/access.py</code>:</p>
<ul>
<li><code>get_image_processing()</code> - Get the ImageProcessingService instance</li>
<li>Enhanced DetectionModelsService access with ultralytics status</li>
</ul>
<p>Convenience accessors for Pillow respecting plugin state:</p>
<ul>
<li><code>get_pil_image()</code></li>
<li><code>get_pil_imagedraw()</code></li>
<li><code>get_pil_imagefont()</code></li>
</ul>
<p>These call into <code>ImageProcessingService</code> when available and fall back to direct Pillow imports.</p>
<pre><code class="hljs"><span class="hljs-function">def <span class="hljs-title">get_pil_image</span><span class="hljs-params">()</span>:
    image_service =</span> <span class="hljs-built_in">get_image_processing</span>()
    <span class="hljs-keyword">return</span> image_service.<span class="hljs-built_in">get_pil_image</span>() <span class="hljs-keyword">if</span> image_service <span class="hljs-keyword">else</span> Image</code></pre><h2>Testing</h2>
<h3>ImageProcessingService Tests</h3>
<p>Comprehensive test coverage in <code>app/tests/services/test_image_processing_service.py</code>:</p>
<ul>
<li>Service initialization and startup</li>
<li>Plugin availability detection (pillow-jxl, pillow-avif)</li>
<li>Supported formats detection</li>
<li>Health checks</li>
<li>Service information</li>
<li>Error handling</li>
</ul>
<p>File: <code>app/tests/services/test_image_processing_service.py</code></p>
<p>Covered cases include plugin detection, supported formats and info, health checks, and shutdown behavior.</p>
<pre><code class="hljs">format_info <span class="hljs-operator">=</span> service.get_format_info()
assert <span class="hljs-string">&quot;.jxl&quot;</span> in format_info
assert format_info[<span class="hljs-string">&quot;.jxl&quot;</span>][<span class="hljs-string">&quot;plugin_name&quot;</span>] <span class="hljs-operator">=</span><span class="hljs-operator">=</span> <span class="hljs-string">&quot;pillow-jxl&quot;</span></code></pre><h3>Test Results</h3>
<p>All tests pass successfully:</p>
<pre><code class="hljs language-plaintext">================================ 9 passed in 1.24s =================================</code></pre><h2>Benefits</h2>
<h3>Performance</h3>
<ul>
<li><strong>Lazy loading</strong> reduces startup time by loading plugins only when needed</li>
<li><strong>Service-based management</strong> provides better resource utilization</li>
<li><strong>Parallel initialization</strong> of independent services</li>
</ul>
<h3>Reliability</h3>
<ul>
<li><strong>Graceful degradation</strong> when plugins are not available</li>
<li><strong>Health monitoring</strong> for plugin availability</li>
<li><strong>Proper error handling</strong> with fallback mechanisms</li>
</ul>
<h3>Maintainability</h3>
<ul>
<li><strong>Centralized plugin management</strong> through services</li>
<li><strong>Consistent API</strong> for plugin availability checking</li>
<li><strong>Service-based architecture</strong> for better code organization</li>
</ul>
<h3>User Experience</h3>
<ul>
<li><strong>Clear logging</strong> of plugin availability status</li>
<li><strong>Informative error messages</strong> when plugins are missing</li>
<li><strong>Service status information</strong> for debugging</li>
</ul>
<h2>Migration Guide</h2>
<h3>For Existing Code</h3>
<p>Existing code that directly imports or checks for plugins will continue to work:</p>
<pre><code class="hljs language-python"><span class="hljs-comment"># This still works</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">import</span> pillow_jxl
    <span class="hljs-comment"># Process JXL images</span>
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-comment"># Handle missing plugin</span>
    <span class="hljs-keyword">pass</span></code></pre><h3>For New Code</h3>
<p>New code should use the service-based approach:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.services.access <span class="hljs-keyword">import</span> get_image_processing

image_service = get_image_processing()
<span class="hljs-keyword">if</span> image_service.is_jxl_supported():
    <span class="hljs-comment"># Process JXL images</span>
    <span class="hljs-keyword">pass</span></code></pre><p>When working with Pillow directly in new code, prefer the service-aware helpers from <code>app.services.access</code> or <code>app.utils.lazy_loader</code> to ensure correct plugin handling.</p>
<h3>For Service Integration</h3>
<p>To integrate with the service system:</p>
<pre><code class="hljs language-python"><span class="hljs-keyword">from</span> app.services.access <span class="hljs-keyword">import</span> get_image_processing, get_detection_models

<span class="hljs-comment"># Get service instances</span>
image_service = get_image_processing()
detection_service = get_detection_models()

<span class="hljs-comment"># Check plugin availability</span>
<span class="hljs-keyword">if</span> image_service.is_jxl_supported():
    <span class="hljs-comment"># JXL support available</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">if</span> detection_service.is_ultralytics_available():
    <span class="hljs-comment"># YOLO models available</span>
    <span class="hljs-keyword">pass</span></code></pre><h2>Future Enhancements</h2>
<h3>Planned Features</h3>
<ul>
<li><strong>Plugin installation management</strong> through services</li>
<li><strong>Dynamic plugin loading</strong> during runtime</li>
<li><strong>Plugin version compatibility</strong> checking</li>
<li><strong>Plugin performance monitoring</strong></li>
</ul>
<h3>Potential Improvements</h3>
<ul>
<li><strong>Plugin marketplace</strong> integration</li>
<li><strong>Automatic plugin discovery</strong></li>
<li><strong>Plugin dependency resolution</strong></li>
<li><strong>Plugin configuration management</strong></li>
</ul>
<h2>Conclusion</h2>
<p>The plugin service integration provides a robust, maintainable, and performant solution for managing plugin dependencies. It maintains backward compatibility while providing a modern service-based architecture for future development.</p>
<p>The implementation successfully addresses the original requirements:</p>
<ul>
<li>✅ Ultralytics moved to lazy loading/service management</li>
<li>✅ Pillow-jxl moved to lazy loading/service management</li>
<li>✅ Pillow-avif moved to lazy loading/service management</li>
<li>✅ Proper dependency management and error handling</li>
<li>✅ Comprehensive test coverage</li>
<li>✅ Backward compatibility maintained</li>
</ul>
<h2>Environment and Packaging Notes</h2>
<ul>
<li>Packages are declared in <code>requirements.txt</code> and <code>requirements.cpu.txt</code> as <code>pillow-avif-plugin</code>, <code>pillow-jxl-plugin</code>, and <code>ultralytics</code>.</li>
<li>Ultralytics caches are directed via <code>YOLO_CONFIG_DIR</code> (see docker-compose files) and commonly mounted to <code>./.ultralytics</code> in the container.</li>
</ul>
<h2>External References</h2>
<ul>
<li>Ultralytics YOLO documentation: <a href="https://docs.ultralytics.com">docs.ultralytics.com</a></li>
<li>Pillow image file formats: <a href="https://pillow.readthedocs.io/en/stable/handbook/image-file-formats.html">Pillow handbook – Image File Formats</a></li>
<li>pillow-avif-plugin (PyPI): <a href="https://pypi.org/project/pillow-avif-plugin/">pypi.org/project/pillow-avif-plugin</a></li>
<li>pillow-jxl-plugin (PyPI): <a href="https://pypi.org/project/pillow-jxl-plugin/">pypi.org/project/pillow-jxl-plugin</a></li>
</ul>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>