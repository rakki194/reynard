<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HuggingFace Cache Configuration - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>HuggingFace Cache Configuration</h1>
      <div class="markdown-content"><h1>HuggingFace Cache Configuration</h1>
<p>This document explains how to configure HuggingFace cache paths for yipyap, including Docker support and environment variable configuration.</p>
<h2>Overview</h2>
<p>yipyap uses HuggingFace Hub for downloading and caching machine learning models. The cache location can be configured using environment variables to support different deployment scenarios, including Docker containers.</p>
<h2>Environment Variables</h2>
<p>The following environment variables control the HuggingFace cache location:</p>
<h3><code>HF_HOME</code> (Recommended)</h3>
<ul>
<li><strong>Priority</strong>: Highest</li>
<li><strong>Description</strong>: The main HuggingFace cache directory</li>
<li><strong>Default</strong>: <code>~/.cache/huggingface</code></li>
<li><strong>Example</strong>: <code>/app/hf_cache</code> or <code>/data/huggingface</code></li>
</ul>
<h3><code>HF_CACHE</code> (Alternative)</h3>
<ul>
<li><strong>Priority</strong>: Medium</li>
<li><strong>Description</strong>: Alternative cache directory variable</li>
<li><strong>Default</strong>: <code>~/.cache/huggingface</code></li>
<li><strong>Example</strong>: <code>/app/hf_cache</code> or <code>/data/huggingface</code></li>
</ul>
<h3>Fallback</h3>
<p>If neither <code>HF_HOME</code> nor <code>HF_CACHE</code> is set, the system defaults to <code>~/.cache/huggingface</code>.</p>
<h2>Local Development</h2>
<h3>Basic Configuration</h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Set HF cache to a custom directory</span>
<span class="hljs-built_in">export</span> HF_HOME=/path/to/your/hf_cache

<span class="hljs-comment"># Or use HF_CACHE</span>
<span class="hljs-built_in">export</span> HF_CACHE=/path/to/your/hf_cache</code></pre><h3>Example with Custom Directory</h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Create a custom cache directory</span>
<span class="hljs-built_in">mkdir</span> -p ~/yipyap_hf_cache

<span class="hljs-comment"># Set environment variable</span>
<span class="hljs-built_in">export</span> HF_HOME=~/yipyap_hf_cache

<span class="hljs-comment"># Run yipyap</span>
python -m app</code></pre><h2>Docker Configuration</h2>
<h3>Using Docker Compose</h3>
<ol>
<li><p><strong>Create a <code>.env</code> file</strong> with your cache configuration:</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># .env</span>
HF_HOME=/app/hf_cache
HF_CACHE_VOLUME=./hf_cache</code></pre></li>
<li><p><strong>Use the provided Docker Compose configuration</strong>:</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Use the HF cache configuration</span>
docker-compose -f docker-compose.hf-cache.yml up

<span class="hljs-comment"># Or for development</span>
docker-compose -f docker-compose.hf-cache.yml up yipyap-backend</code></pre></li>
</ol>
<h3>Manual Docker Run</h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Create cache directory</span>
<span class="hljs-built_in">mkdir</span> -p ./hf_cache

<span class="hljs-comment"># Run with volume mount</span>
docker run -d \
  -p 7000:7000 \
  -v $(<span class="hljs-built_in">pwd</span>)/data:/app/images \
  -v $(<span class="hljs-built_in">pwd</span>)/hf_cache:/app/hf_cache \
  -e HF_HOME=/app/hf_cache \
  yipyap:latest</code></pre><h3>Docker Compose Examples</h3>
<h4>Development with Persistent Cache</h4>
<pre><code class="hljs language-yaml"><span class="hljs-comment"># docker-compose.override.yml</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">yipyap-backend:</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">HF_HOME:</span> <span class="hljs-string">/app/hf_cache</span>
      <span class="hljs-attr">HF_CACHE:</span> <span class="hljs-string">/app/hf_cache</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./hf_cache:/app/hf_cache</span></code></pre><h4>Production with Named Volume</h4>
<pre><code class="hljs language-yaml"><span class="hljs-comment"># docker-compose.prod.yml</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">yipyap:</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">HF_HOME:</span> <span class="hljs-string">/app/hf_cache</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">hf_cache:/app/hf_cache</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">hf_cache:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span></code></pre><h2>Cache Directory Structure</h2>
<p>The HuggingFace cache follows this structure:</p>
<pre><code class="hljs language-plaintext">{HF_HOME}/
├── hub/
│   ├── models--RedRocket--JointTaggerProject/
│   │   └── snapshots/
│   │       └── main/
│   │           ├── JTP_PILOT2-e3-vit_so400m_patch14_siglip_384.safetensors
│   │           └── tags.json
│   ├── models--fancyfeast--llama-joycaption-beta-one-hf-llava/
│   │   └── snapshots/
│   │       └── main/
│   │           ├── config.json
│   │           ├── pytorch_model.bin
│   │           └── ...
│   └── models--fancyfeast--joycaption-watermark-detection/
│       └── snapshots/
│           └── main/
│               ├── yolo11x-train28-best.pt
│               └── far5y1y5-8000.pt
└── ...</code></pre><h2>Model Downloads</h2>
<p>The following models are automatically downloaded to the HF cache:</p>
<ol>
<li><p><strong>JTP2 Model</strong> (<code>RedRocket/JointTaggerProject</code>)</p>
<ul>
<li>Model file: <code>JTP_PILOT2-e3-vit_so400m_patch14_siglip_384.safetensors</code></li>
<li>Tags file: <code>tags.json</code></li>
</ul>
</li>
<li><p><strong>JoyCaption Model</strong> (<code>fancyfeast/llama-joycaption-beta-one-hf-llava</code>)</p>
<ul>
<li>Complete model files for LLaVA-based caption generation</li>
</ul>
</li>
<li><p><strong>Watermark Detection Models</strong> (<code>fancyfeast/joycaption-watermark-detection</code>)</p>
<ul>
<li>YOLO model: <code>yolo11x-train28-best.pt</code></li>
<li>OWLv2 model: <code>far5y1y5-8000.pt</code></li>
</ul>
</li>
</ol>
<h2>Benefits</h2>
<h3>Persistent Storage</h3>
<ul>
<li>Models are cached and persist across container restarts</li>
<li>No need to re-download models on every deployment</li>
</ul>
<h3>Shared Cache</h3>
<ul>
<li>Multiple containers can share the same cache directory</li>
<li>Reduces storage requirements and download time</li>
</ul>
<h3>Flexible Configuration</h3>
<ul>
<li>Environment variable support allows easy configuration</li>
<li>Works seamlessly in local, Docker, and cloud environments</li>
</ul>
<h3>Performance</h3>
<ul>
<li>Faster startup times after initial model download</li>
<li>Reduced bandwidth usage for repeated deployments</li>
</ul>
<h2>Troubleshooting</h2>
<h3>Cache Permission Issues</h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Ensure proper permissions for Docker</span>
<span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> -R 1000:1000 ./hf_cache

<span class="hljs-comment"># Or set UID/GID in Docker Compose</span>
<span class="hljs-built_in">export</span> UID=$(<span class="hljs-built_in">id</span> -u)
<span class="hljs-built_in">export</span> GID=$(<span class="hljs-built_in">id</span> -g)</code></pre><h3>Cache Location Verification</h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Check current cache location</span>
python -c <span class="hljs-string">&quot;from app.utils.hf_cache import get_hf_cache_dir; print(get_hf_cache_dir())&quot;</span>

<span class="hljs-comment"># List cached models</span>
<span class="hljs-built_in">ls</span> -la $(python -c <span class="hljs-string">&quot;from app.utils.hf_cache import get_hf_cache_dir; print(get_hf_cache_dir())&quot;</span>)/hub/</code></pre><h3>Clearing Cache</h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Remove specific model cache</span>
<span class="hljs-built_in">rm</span> -rf ~/.cache/huggingface/hub/models--fancyfeast--llama-joycaption-beta-one-hf-llava

<span class="hljs-comment"># Clear entire cache (use with caution)</span>
<span class="hljs-built_in">rm</span> -rf ~/.cache/huggingface</code></pre><h2>Best Practices</h2>
<ol>
<li><strong>Use Named Volumes</strong> for production deployments</li>
<li><strong>Set HF_HOME</strong> explicitly in Docker environments</li>
<li><strong>Monitor Cache Size</strong> as models can be large (several GB)</li>
<li><strong>Backup Cache</strong> for critical deployments</li>
<li><strong>Use Bind Mounts</strong> for development to easily inspect cache contents</li>
</ol>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>