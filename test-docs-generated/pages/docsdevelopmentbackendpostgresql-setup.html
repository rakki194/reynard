<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PostgreSQL Integration for Yipyap Gatekeeper - Reynard Documentation Test</title>
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../highlight.css">
  <link rel="icon" href="/favicon.ico">
</head>
<body>
  <nav class="docs-nav">
    <div class="nav-brand"><a href="../index.html">Reynard Documentation Test</a></div>
    <div class="nav-links"><a href="../index.html">Home</a><a href="../api.html">API Reference</a></div>
  </nav>
  <main class="docs-main">
    <div class="docs-content">
      <h1>PostgreSQL Integration for Yipyap Gatekeeper</h1>
      <div class="markdown-content"><h1>PostgreSQL Integration for Yipyap Gatekeeper</h1>
<p>This document explains how to set up PostgreSQL for persistent user storage in<br>Yipyap&#39;s Gatekeeper authentication system.</p>
<h2>Overview</h2>
<p>By default, Yipyap uses an in-memory backend for user storage, which means all<br>users are lost when the application restarts. This PostgreSQL integration<br>provides persistent user storage, ensuring your users remain available across<br>application restarts.</p>
<h2>Features</h2>
<ul>
<li><strong>Persistent User Storage</strong>: Users are stored in PostgreSQL and persist across<br>application restarts</li>
<li><strong>Automatic Table Creation</strong>: Database tables are created automatically when<br>the application starts</li>
<li><strong>Connection Pooling</strong>: Efficient database connection management</li>
<li><strong>Health Checks</strong>: Built-in database health monitoring</li>
<li><strong>Docker Support</strong>: Easy setup with Docker Compose</li>
</ul>
<h2>Quick Start</h2>
<h3>Option 1: Using Docker Compose (Recommended)</h3>
<ol>
<li><p><strong>Start PostgreSQL</strong>:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">cd</span> yipyap
docker-compose -f docker-compose.postgres.yml up -d</code></pre></li>
<li><p><strong>Set Environment Variables</strong> (optional, defaults are provided):</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">&quot;postgresql://yipyap:yipyap@localhost:5432/yipyap&quot;</span></code></pre></li>
<li><p><strong>Start Yipyap</strong>:</p>
<pre><code class="hljs language-bash">python -m app.main</code></pre></li>
</ol>
<h3>Option 2: Manual PostgreSQL Setup</h3>
<ol>
<li><p><strong>Install PostgreSQL</strong> on your system</p>
</li>
<li><p><strong>Create Database and User</strong>:</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Connect to PostgreSQL as superuser</span>
<span class="hljs-built_in">sudo</span> -u postgres psql

<span class="hljs-comment"># Create database and user</span>
CREATE DATABASE yipyap;
CREATE USER yipyap WITH PASSWORD <span class="hljs-string">&#x27;yipyap&#x27;</span>;
GRANT ALL PRIVILEGES ON DATABASE yipyap TO yipyap;
\q</code></pre></li>
<li><p><strong>Set Environment Variables</strong>:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">&quot;postgresql://yipyap:yipyap@localhost:5432/yipyap&quot;</span></code></pre></li>
<li><p><strong>Start Yipyap</strong>:</p>
<pre><code class="hljs language-bash">python -m app.main</code></pre></li>
</ol>
<h3>Option 3: Using the Setup Script</h3>
<ol>
<li><p><strong>Run the setup script</strong>:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">cd</span> yipyap
python scripts/setup_postgres.py --all</code></pre></li>
<li><p><strong>Start Yipyap</strong>:</p>
<pre><code class="hljs language-bash">python -m app.main</code></pre></li>
</ol>
<h2>Configuration</h2>
<h3>Environment Variables</h3>
<p>You can configure the PostgreSQL connection using environment variables:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>DATABASE_URL</code></td>
<td><code>None</code></td>
<td>Full PostgreSQL connection URL</td>
</tr>
<tr>
<td><code>POSTGRES_HOST</code></td>
<td><code>localhost</code></td>
<td>PostgreSQL host</td>
</tr>
<tr>
<td><code>POSTGRES_PORT</code></td>
<td><code>5432</code></td>
<td>PostgreSQL port</td>
</tr>
<tr>
<td><code>POSTGRES_USER</code></td>
<td><code>yipyap</code></td>
<td>PostgreSQL username</td>
</tr>
<tr>
<td><code>POSTGRES_PASSWORD</code></td>
<td><code>yipyap</code></td>
<td>PostgreSQL password</td>
</tr>
<tr>
<td><code>POSTGRES_DB</code></td>
<td><code>yipyap</code></td>
<td>PostgreSQL database name</td>
</tr>
<tr>
<td><code>POSTGRES_POOL_SIZE</code></td>
<td><code>10</code></td>
<td>Connection pool size</td>
</tr>
<tr>
<td><code>POSTGRES_MAX_OVERFLOW</code></td>
<td><code>20</code></td>
<td>Max overflow connections</td>
</tr>
<tr>
<td><code>POSTGRES_ECHO</code></td>
<td><code>false</code></td>
<td>Echo SQL statements (debugging)</td>
</tr>
</tbody></table>
<h3>Example Configuration</h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># Using DATABASE_URL (recommended)</span>
<span class="hljs-built_in">export</span> DATABASE_URL=<span class="hljs-string">&quot;postgresql://username:password@host:5432/database&quot;</span>

<span class="hljs-comment"># Or using individual settings</span>
<span class="hljs-built_in">export</span> POSTGRES_HOST=<span class="hljs-string">&quot;localhost&quot;</span>
<span class="hljs-built_in">export</span> POSTGRES_PORT=<span class="hljs-string">&quot;5432&quot;</span>
<span class="hljs-built_in">export</span> POSTGRES_USER=<span class="hljs-string">&quot;yipyap&quot;</span>
<span class="hljs-built_in">export</span> POSTGRES_PASSWORD=<span class="hljs-string">&quot;secure_password&quot;</span>
<span class="hljs-built_in">export</span> POSTGRES_DB=<span class="hljs-string">&quot;yipyap&quot;</span></code></pre><h2>Database Schema</h2>
<p>The PostgreSQL backend automatically creates the following table:</p>
<h3>Users Table</h3>
<pre><code class="hljs language-sql"><span class="hljs-keyword">CREATE TABLE</span> users (
    id UUID <span class="hljs-keyword">PRIMARY KEY</span> <span class="hljs-keyword">DEFAULT</span> uuid_generate_v4(),
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT NULL</span>,
    password_hash <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT NULL</span>,
    role <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;regular&#x27;</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">UNIQUE</span>,
    profile_picture_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),
    yapcoin_balance <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    is_active <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">TRUE</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    metadata JSONB <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;{}&#x27;</span>
);

<span class="hljs-comment">-- Indexes</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> INDEX idx_users_email <span class="hljs-keyword">ON</span> users(email);</code></pre><h2>Migration from Memory Backend</h2>
<p>If you&#39;re currently using the memory backend and want to migrate to PostgreSQL:</p>
<ol>
<li><strong>Start PostgreSQL</strong> (see Quick Start above)</li>
<li><strong>Restart Yipyap</strong> with PostgreSQL configuration</li>
<li><strong>Re-register your users</strong> through the API</li>
<li><strong>Your users will now persist</strong> across application restarts</li>
</ol>
<h2>Troubleshooting</h2>
<h3>Common Issues</h3>
<ol>
<li><p><strong>Connection Refused</strong>:</p>
<ul>
<li>Ensure PostgreSQL is running</li>
<li>Check host and port settings</li>
<li>Verify firewall settings</li>
</ul>
</li>
<li><p><strong>Authentication Failed</strong>:</p>
<ul>
<li>Verify username and password</li>
<li>Check user permissions</li>
<li>Ensure user has access to the database</li>
</ul>
</li>
<li><p><strong>Database Not Found</strong>:</p>
<ul>
<li>Create the database manually or use the setup script</li>
<li>Check database name in connection string</li>
</ul>
</li>
</ol>
<h3>Debug Mode</h3>
<p>Enable SQL statement logging for debugging:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">export</span> POSTGRES_ECHO=<span class="hljs-literal">true</span></code></pre><h3>Health Check</h3>
<p>Test the database connection:</p>
<pre><code class="hljs language-bash">python scripts/setup_postgres.py --<span class="hljs-built_in">test</span></code></pre><h2>Performance Considerations</h2>
<ul>
<li><strong>Connection Pooling</strong>: The backend uses SQLAlchemy connection pooling for<br>efficient database connections</li>
<li><strong>Indexes</strong>: Automatic indexes are created on username and email fields</li>
<li><strong>JSONB</strong>: User metadata is stored as JSONB for efficient querying</li>
<li><strong>UUIDs</strong>: User IDs use UUIDs for better distribution and security</li>
</ul>
<h2>Security Notes</h2>
<ul>
<li><strong>Password Hashing</strong>: Passwords are hashed using Argon2 before storage</li>
<li><strong>Connection Security</strong>: Use SSL connections in production</li>
<li><strong>Environment Variables</strong>: Store sensitive configuration in environment<br>variables, not in code</li>
<li><strong>Database Permissions</strong>: Limit database user permissions to only what&#39;s<br>necessary</li>
</ul>
<h2>Production Deployment</h2>
<p>For production deployment:</p>
<ol>
<li><strong>Use a managed PostgreSQL service</strong> (AWS RDS, Google Cloud SQL, etc.)</li>
<li><strong>Enable SSL connections</strong></li>
<li><strong>Use strong passwords</strong></li>
<li><strong>Set up automated backups</strong></li>
<li><strong>Monitor database performance</strong></li>
<li><strong>Use connection pooling</strong> (already configured)</li>
</ol>
<h2>Support</h2>
<p>If you encounter issues:</p>
<ol>
<li>Check the application logs for error messages</li>
<li>Verify PostgreSQL is running and accessible</li>
<li>Test the connection using the setup script</li>
<li>Check the troubleshooting section above</li>
<li>Review the Gatekeeper library documentation</li>
</ol>
</div>
    </div>
  </main>
  <footer class="docs-footer"><p>&copy; 2024 Reynard Documentation Test. Built with ❤️ using SolidJS.</p></footer>
</body>
</html>